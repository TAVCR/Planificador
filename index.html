<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador Antolog√≠as</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#A99D8B">
    <link id="manifest-link" rel="manifest">
    <link id="apple-touch-icon-link" rel="apple-touch-icon">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212; /* Dark background default */
            color: #E0E0E0; /* Light text default */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme change */
        }
        .nav-active {
            background-color: #A99D8B; /* Muted accent */
            color: #121212; /* Dark text for contrast */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .nav-inactive {
            background-color: #2C2C2C; /* Darker inactive background */
            color: #A0A0A0; /* Lighter muted text */
        }
        .calendar-grid-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding: 0 0.5rem;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding: 0 0.5rem;
        }
        .day {
            aspect-ratio: 1 / 1;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.3s, background-color 0.3s, color 0.3s; /* Add color transitions */
            position: relative;
        }
        .day:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); /* Stronger shadow for dark mode */
            z-index: 10;
        }
        .day.selected {
            box-shadow: 0 0 0 3px #A99D8B;
            z-index: 20;
        }
        .bg-neutral-day { background-color: #383838; } /* Darker neutral day */
        .bg-empty-day { background-color: transparent; }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 450px;
        }
        @media (min-width: 768px) {
            .chart-container { height: 400px; }
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .filter-btn-active {
            background-color: #8C7B6C !important;
            color: white !important;
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.25);
        }
        .day-filtered {
            opacity: 0.15; /* More aggressive fade for dark mode */
            pointer-events: none;
        }
        .priority-star {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            color: rgba(0, 0, 0, 0.7); /* Dark star for light backgrounds */
        }
        .bg-green-opportunity .priority-star,
        .bg-red-opportunity .priority-star,
        .bg-blue-payday .priority-star {
             color: rgba(255, 255, 255, 0.8); /* Light star for dark backgrounds */
        }

        /* Custom dark mode overrides (default) */
        .dark-mode-bg { background-color: #1E1E1E; }
        .dark-mode-text { color: #E0E0E0; }
        .dark-mode-text-muted { color: #A0A0A0; }
        .dark-mode-text-header { color: #D4C8B8; }
        .dark-mode-text-accent { color: #BFAE9B; }
        .dark-mode-surface { background-color: #2C2C2C; }
        .dark-mode-border { border-color: #444444; }
        .dark-mode-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.5), 0 2px 4px -2px rgb(0 0 0 / 0.4); }
        .dark-mode-inner-shadow { box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.5); }

        /* =================================================================================
           LIGHT MODE STYLES
           These styles will be applied when the 'light-mode' class is added to the body.
           They override the dark mode styles.
           ================================================================================= */
        body.light-mode {
            background-color: #F0F0F0; /* Light background */
            color: #333333; /* Dark text */
        }
        body.light-mode .dark-mode-bg { background-color: #FFFFFF; }
        body.light-mode .dark-mode-text { color: #333333; }
        body.light-mode .dark-mode-text-muted { color: #666666; }
        body.light-mode .dark-mode-text-header { color: #1A1A1A; }
        body.light-mode .dark-mode-text-accent { color: #6D5D4B; }
        body.light-mode .dark-mode-surface { background-color: #FFFFFF; }
        body.light-mode .dark-mode-border { border-color: #CCCCCC; }
        body.light-mode .dark-mode-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        body.light-mode .dark-mode-inner-shadow { box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05); }

        body.light-mode .nav-inactive {
            background-color: #E0E0E0; /* Lighter inactive background */
            color: #555555; /* Darker muted text */
        }
        body.light-mode .filter-btn {
            background-color: #E0E0E0; /* Lighter filter button background */
            color: #555555;
        }
        body.light-mode .filter-btn-active {
            background-color: #A99D8B !important; /* Active filter button */
            color: white !important;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1);
        }
        body.light-mode .bg-neutral-day { 
            background-color: #F5F5F5; /* Lighter neutral day */
            color: #555555;
        }
        body.light-mode .day:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); /* Lighter shadow for light mode */
        }
        body.light-mode .day.selected {
            box-shadow: 0 0 0 3px #A99D8B;
        }
        body.light-mode .priority-star {
            color: rgba(0, 0, 0, 0.7); /* Dark star for light backgrounds */
        }
        body.light-mode .bg-green-opportunity .priority-star,
        body.light-mode .bg-red-opportunity .priority-star,
        body.light-mode .bg-blue-payday .priority-star {
             color: rgba(0, 0, 0, 0.7); /* Dark star for colored backgrounds in light mode */
        }
        body.light-mode .accordion-button {
            background-color: #E0E0E0;
        }
        body.light-mode .accordion-button:hover {
            background-color: #D5D5D5;
        }
        body.light-mode .bg-gray-800 { /* For strategy cards */
            background-color: #E0E0E0;
            color: #333333;
        }
        body.light-mode #climate-table thead {
            background-color: #E0E0E0;
            color: #333333;
        }
        body.light-mode #climate-table tbody tr {
            border-color: #E5E5E5;
        }
        body.light-mode .text-green-300 { color: #1E88E5; } /* Adjust for contrast in light mode */
        body.light-mode .bg-green-900 { background-color: #E8F5E9; }
        body.light-mode .text-yellow-300 { color: #FFA000; }
        body.light-mode .bg-yellow-900 { background-color: #FFFDE7; }
        body.light-mode .text-red-300 { color: #D32F2F; }
        body.light-mode .bg-red-900 { background-color: #FFEBEE; }

        /* Specific styles for year buttons to ensure proper theme application */
        .year-btn-active-dark {
            background-color: #A99D8B !important; /* Dark mode active color */
            color: #121212 !important; /* Dark mode active text */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .year-btn-active-dark:hover {
            background-color: #8C7B6C !important; /* Slightly darker on hover */
        }

        .year-btn-inactive-dark {
            background-color: #2C2C2C !important; /* Darker inactive background */
            color: #A0A0A0 !important; /* Lighter muted text */
        }
        .year-btn-inactive-dark:hover {
            background-color: #383838 !important; /* Slightly lighter on hover */
        }

        .year-btn-active-light {
            background-color: #C3B8A8 !important; /* Light mode active color (lighter accent) */
            color: #FFFFFF !important; /* White text for contrast */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .year-btn-active-light:hover {
            background-color: #A99D8B !important; /* Slightly darker on hover */
        }

        .year-btn-inactive-light {
            background-color: #E0E0E0 !important; /* Lighter inactive background */
            color: #555555 !important; /* Darker muted text */
        }
        .year-btn-inactive-light:hover {
            background-color: #D5D5D5 !important; /* Slightly darker on hover */
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #calendars-container, #calendars-container * {
                visibility: visible;
            }
            #calendars-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .lg\:col-span-8 {
                width: 100% !important;
            }
            .sm\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
             .xl\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="dark-mode-text antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-screen-2xl">
        <header class="text-center mb-8 flex flex-col sm:flex-row justify-between items-center">
            <!-- Wrapped title and subtitle for better stacking on small screens -->
            <div class="flex flex-col items-center sm:items-start flex-grow">
                <h1 class="text-3xl md:text-5xl font-bold dark-mode-text-header">Planificador Estrat√©gico de Eventos</h1>
                <p class="text-lg dark-mode-text-accent mt-2">Restaurante Antolog√≠as: 2025-2026</p>
            </div>
            <!-- Theme Toggle Buttons -->
            <div class="flex space-x-2 mt-4 sm:mt-0 sm:ml-4">
                <button id="theme-toggle" class="px-4 py-2.5 text-lg bg-gray-700 text-gray-200 font-semibold rounded-lg hover:bg-gray-600 transition-all duration-300 transform hover:scale-105">‚òÄÔ∏è</button>
                <button id="colorblind-toggle" class="px-4 py-2.5 text-lg bg-gray-700 text-gray-200 font-semibold rounded-lg hover:bg-gray-600 transition-all duration-300 transform hover:scale-105">üåà</button>
            </div>
        </header>

        <nav class="flex flex-wrap justify-center mb-8 dark-mode-surface rounded-full p-1 max-w-xl mx-auto dark-mode-inner-shadow">
            <button id="nav-calendario" class="nav-btn nav-active flex-1 py-2 px-4 rounded-full text-sm sm:text-base font-semibold transition-all duration-300">üìÖ Calendario</button>
            <button id="nav-analisis" class="nav-btn nav-inactive flex-1 py-2 px-4 rounded-full text-sm sm:text-base font-semibold transition-all duration-300">üîç An√°lisis</button>
            <button id="nav-estrategias" class="nav-btn nav-inactive flex-1 py-2 px-4 rounded-full text-sm sm:text-base font-semibold transition-all duration-300">üí° Estrategias</button>
            <button id="nav-clima" class="nav-btn nav-inactive flex-1 py-2 px-4 rounded-full text-sm sm:text-base font-semibold transition-all duration-300">üå¶Ô∏è Clima</button>
        </nav>

        <main id="main-content">
            <!-- CALENDAR VIEW -->
            <div id="view-calendario">
                <p class="text-center dark-mode-text-muted mb-6 max-w-3xl mx-auto">Esta es tu herramienta principal de planificaci√≥n. Selecciona un a√±o para ver el calendario de oportunidades. Haz clic en cualquier d√≠a para ver el an√°lisis detallado de por qu√© se clasific√≥ con un color espec√≠fico, ayud√°ndote a tomar decisiones informadas sobre programaci√≥n, marketing y asignaci√≥n de recursos.</p>
                <div class="flex justify-center items-center mb-6 space-x-4">
                    <!-- Removed initial color classes from HTML, will be applied via JS -->
                    <button id="year-2025" class="year-btn px-8 py-2.5 text-lg font-semibold rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">2025</button>
                    <button id="year-2026" class="year-btn px-8 py-2.5 text-lg font-semibold rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">2026</button>
                    <button id="print-btn" class="px-4 py-2.5 text-lg bg-gray-700 text-gray-200 font-semibold rounded-lg hover:bg-gray-600 transition-all duration-300 transform hover:scale-105">üñ®Ô∏è</button>
                </div>
                
                <div class="flex flex-wrap justify-center items-center gap-x-4 sm:gap-x-6 gap-y-2 mb-4 text-xs sm:text-sm text-gray-700">
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-opportunity mr-2 border border-gray-400"></span>Oportunidad Alta</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-yellow-opportunity mr-2 border border-gray-400"></span>Riesgo Medio</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-red-opportunity mr-2 border border-gray-400"></span>Riesgo Alto</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-blue-payday mr-2 border border-gray-400"></span>D√≠a de Pago</div>
                </div>

                <div id="filter-container" class="flex flex-wrap justify-center items-center gap-2 mb-8 p-2 dark-mode-surface rounded-full max-w-2xl mx-auto">
                    <button class="filter-btn flex-1 py-1 px-3 text-xs sm:text-sm rounded-full" data-filter="all">Todos</button>
                    <button class="filter-btn flex-1 py-1 px-3 text-xs sm:text-sm rounded-full bg-[#383838]" data-filter="green">üü¢ Verdes</button>
                    <button class="filter-btn flex-1 py-1 px-3 text-xs sm:text-sm rounded-full bg-[#383838]" data-filter="yellow">üü° Amarillos</button>
                    <button class="filter-btn flex-1 py-1 px-3 text-xs sm:text-sm rounded-full bg-[#383838]" data-filter="red">üî¥ Rojos</button>
                    <button class="filter-btn flex-1 py-1 px-3 text-xs sm:text-sm rounded-full bg-[#383838]" data-filter="blue">üîµ D√≠as de Pago</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div id="calendars-container" class="lg:col-span-8">
                        <!-- Calendar Grids will be injected here by JS -->
                    </div>

                    <div id="details-panel" class="hidden lg:block lg:col-span-4 p-6 dark-mode-surface rounded-2xl dark-mode-shadow self-start sticky top-8">
                        <h3 class="font-bold text-xl mb-4 dark-mode-text-header">Detalles del D√≠a</h3>
                        <div id="details-content-desktop" class="dark-mode-text-muted space-y-3 min-h-[150px]">
                            <p class="text-center dark-mode-text-muted pt-8">Selecciona una fecha en el calendario.</p>
                        </div>
                    </div>
                </div>

                <div class="mt-12 px-2 py-1 sm:p-4 dark-mode-surface rounded-2xl dark-mode-shadow"> <!-- Adjusted padding here -->
                    <h2 class="text-2xl font-bold text-center mb-4 dark-mode-text-header">Comparativa de Oportunidades (Viernes y S√°bados)</h2>
                     <div class="chart-container">
                        <canvas id="opportunityChart"></canvas>
                    </div>
                </div>

                <!-- New section for Payday chart -->
                <div class="mt-12 px-2 py-1 sm:p-4 dark-mode-surface rounded-2xl dark-mode-shadow">
                    <h2 class="text-2xl font-bold text-center mb-4 dark-mode-text-header">Frecuencia de D√≠as de Pago</h2>
                    <div class="chart-container">
                        <canvas id="paydayChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- ANALYSIS VIEW -->
            <div id="view-analisis" class="hidden">
                 <div class="max-w-4xl mx-auto p-4 md:p-8 dark-mode-surface rounded-2xl dark-mode-shadow">
                    <h2 class="text-2xl md:text-3xl font-bold text-center mb-4 dark-mode-text-header">Factores Clave de Decisi√≥n</h2>
                    <p class="text-center dark-mode-text-muted mb-8">La clasificaci√≥n de cada fecha responde a la interacci√≥n de estas seis fuerzas principales. Comprenderlas es fundamental para interpretar el calendario y anticipar el comportamiento del p√∫blico. Haz clic en cada factor para expandir la informaci√≥n.</p>
                    <div class="space-y-4" id="accordion-container">
                        <!-- Accordion items will be injected here -->
                    </div>
                </div>
            </div>

            <!-- STRATEGIES VIEW -->
            <div id="view-estrategias" class="hidden">
                 <div class="max-w-6xl mx-auto">
                    <h2 class="text-2xl md:text-3xl font-bold text-center mb-4 dark-mode-text-header">Recomendaciones Estrat√©gicas</h2>
                     <p class="text-center dark-mode-text-muted mb-8">Aplica estas t√°cticas para maximizar resultados en fechas de alta oportunidad y mitigar riesgos en las m√°s complejas. La clave no es solo saber *cu√°ndo* actuar, sino *c√≥mo* hacerlo.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
                        <div class="bg-gray-800 border-l-4 border-green-600 text-gray-200 p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300">
                            <h3 class="font-bold text-xl mb-3 flex items-center"><span class="text-3xl mr-3">üü¢</span> Fechas Verdes: Maximizar</h3>
                            <ul class="list-disc list-inside space-y-2 text-sm">
                                <li>Invertir en artistas de mayor convocatoria y costo.</li>
                                <li>Lanzar campa√±as de marketing agresivas y con antelaci√≥n.</li>
                                <li>Crear "eventos de firma" recurrentes para generar expectativa (ej. "Viernes de Quincena").</li>
                                 <li>Considerar precios de entrada diferenciados o paquetes premium.</li>
                            </ul>
                        </div>
                        <div class="bg-gray-800 border-l-4 border-yellow-500 text-gray-200 p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300">
                            <h3 class="font-bold text-xl mb-3 flex items-center"><span class="text-3xl mr-3">üü°</span> Fechas Amarillas: Navegar</h3>
                            <ul class="list-disc list-inside space-y-2 text-sm">
                                <li>Aplicar contraprogramaci√≥n: si hay un concierto masivo de pop, ofrecer una noche de jazz o trova.</li>
                                <li>Ofrecer paquetes de complemento: "Cena + M√∫sica Ac√∫stica + Ver el Partido" en noches de f√∫tbol.</li>
                                <li>Apuntar a nichos de mercado que buscan activamente una alternativa al evento principal.</li>
                                <li>Usar promociones t√°cticas (ej. 2x1 en c√≥cteles) para incentivar la visita.</li>
                            </ul>
                        </div>
                         <div class="bg-gray-800 border-l-4 border-red-600 text-gray-200 p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300">
                            <h3 class="font-bold text-xl mb-3 flex items-center"><span class="text-3xl mr-3">üî¥</span> Fechas Rojas: Mitigar</h3>
                             <ul class="list-disc list-inside space-y-2 text-sm">
                                <li>Considerar no programar eventos abiertos. Promover el local para eventos privados.</li>
                                <li>Optar por programaci√≥n de muy bajo costo (m√∫sicos de la casa, talento emergente).</li>
                                <li>Planificar cierres estrat√©gicos para mantenimiento o descanso del personal.</li>
                                <li>Enfocar la comunicaci√≥n en el servicio de restaurante, no en el evento musical.</li>
                            </ul>
                        </div>
                    </div>
                     <div class="mt-10 dark-mode-surface p-8 rounded-2xl dark-mode-shadow">
                        <h3 class="font-bold text-xl mb-6 dark-mode-text-header text-center">üí° Oportunidades T√°cticas Adicionales</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                            <div class="p-4 rounded-lg bg-gray-800">
                                <h4 class="font-semibold text-lg dark-mode-text-accent">Jueves de Escape</h4>
                                <p class="text-sm mt-1">Programar eventos los jueves previos a un fin de semana largo para capturar al p√∫blico antes de que viaje.</p>
                            </div>
                            <div class="p-4 rounded-lg bg-gray-800">
                                <h4 class="font-semibold text-lg dark-mode-text-accent">V√≠speras de Feriado</h4>
                                <p class="text-sm mt-1">La noche previa a un feriado entre semana (ej. un lunes o martes) es una oportunidad de alta convocatoria.</p>
                            </div>
                            <div class="p-4 rounded-lg bg-gray-800">
                                <h4 class="font-semibold text-lg dark-mode-text-accent">Festival Anti-√âxodo</h4>
                                <p class="text-sm mt-1">Crear un evento tem√°tico para los que se quedan en la ciudad durante las vacaciones de medio a√±o.</p>
                            </div>
                            <div class="p-4 rounded-lg bg-gray-800">
                                <h4 class="font-semibold text-lg dark-mode-text-accent">Celebraci√≥n Cultural</h4>
                                <p class="text-sm mt-1">Desarrollar eventos tem√°ticos √∫nicos como "Fin de la Cosecha Cafetalera" para diferenciar la oferta.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CLIMATE VIEW -->
            <div id="view-clima" class="hidden">
                <!-- Added pt-6 for mobile spacing, md:pt-8 for desktop -->
                <div class="max-w-4xl mx-auto p-4 md:p-8 dark-mode-surface rounded-2xl dark-mode-shadow pt-6 md:pt-8">
                    <h2 class="text-2xl md:text-3xl font-bold text-center mb-4 dark-mode-text-header">An√°lisis de Riesgo Clim√°tico</h2>
                    <p class="text-center dark-mode-text-muted mb-8">Esta secci√≥n eval√∫a el riesgo de lluvia para la exhibici√≥n de veh√≠culos hist√≥ricos (primer martes de cada mes, 6 PM - 10 PM), basado en patrones hist√≥ricos del Valle Central. No es un pron√≥stico, sino una gu√≠a para la planificaci√≥n log√≠stica (ej. necesidad de carpas) y la comunicaci√≥n con el p√∫blico.</p>
                    <div class="overflow-x-auto">
                        <table id="climate-table" class="w-full text-sm text-left dark-mode-text-muted">
                           <thead class="text-xs dark-mode-text-header uppercase bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 rounded-l-lg">Mes</th>
                                    <th scope="col" class="px-6 py-3">Riesgo de Lluvia</th>
                                    <th scope="col" class="px-6 py-3 rounded-r-lg">Justificaci√≥n y Recomendaci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Climate data injected by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Modal -->
    <div id="details-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="dark-mode-surface rounded-2xl shadow-2xl p-6 w-full max-w-sm mx-auto transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl dark-mode-text-header">Detalles del D√≠a</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div id="details-content-mobile" class="dark-mode-text-muted space-y-3">
                <!-- Mobile details will be injected here -->
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // =================================================================================
    // CENTRAL COLOR CONFIGURATION
    // Modify these values to change the color palette of the entire application.
    // =================================================================================
    const defaultColorPalette = {
        opportunityHigh: {
            bg: '#2E7D32', // Green
            text: '#FFFFFF'
        },
        opportunityMedium: {
            bg: '#FFC107', // Yellow
            text: '#3D3B38'
        },
        opportunityLow: {
            bg: '#C62828', // Red
            text: '#FFFFFF'
        },
        payday: {
            bg: '#1565C0', // Blue
            text: '#FFFFFF'
        }
    };

    // Colorblind-friendly palette (Purple for Green, Orange for Red)
    const colorblindColorPalette = {
        opportunityHigh: {
            bg: '#9933CC', // Distinct Purple for High Opportunity (was Strong Blue)
            text: '#FFFFFF'
        },
        opportunityMedium: {
            bg: '#FFC107', // Yellow (same as default) for Medium Risk
            text: '#3D3B38'
        },
        opportunityLow: {
            bg: '#FF6600', // Bright Orange for High Risk
            text: '#FFFFFF'
        },
        payday: {
            bg: '#1565C0', // Blue (same as default) for Payday
            text: '#FFFFFF'
        }
    };

    let currentActiveColorPalette; // This will be set based on isColorblindMode

    // Function to dynamically inject color styles based on the active palette
    const injectColorStyles = (palette) => {
        let style = document.getElementById('dynamic-color-styles');
        if (!style) {
            style = document.createElement('style');
            style.id = 'dynamic-color-styles';
            document.head.appendChild(style);
        }
        style.innerHTML = `
            .bg-green-opportunity { background-color: ${palette.opportunityHigh.bg}; color: ${palette.opportunityHigh.text}; }
            .bg-yellow-opportunity { background-color: ${palette.opportunityMedium.bg}; color: ${palette.opportunityMedium.text}; }
            .bg-red-opportunity { background-color: ${palette.opportunityLow.bg}; color: ${palette.opportunityLow.text}; }
            .bg-blue-payday { background-color: ${palette.payday.bg}; color: ${palette.payday.text}; }
        `;
    };

    // Function to generate a dynamic icon and manifest for PWA
    const setupPwaAssets = () => {
        const canvas = document.createElement('canvas');
        canvas.width = 192;
        canvas.height = 192;
        const ctx = canvas.getContext('2d');

        // Draw Icon
        ctx.fillStyle = '#6D5D4B'; // Background color
        ctx.fillRect(0, 0, 192, 192);
        ctx.font = 'bold 120px sans-serif';
        ctx.fillStyle = '#FFFFFF';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('A', 192 / 2, 192 / 2 + 10);
        
        const iconUrl = canvas.toDataURL('image/png');
        
        document.getElementById('apple-touch-icon-link').href = iconUrl;

        // Create Manifest
        const manifest = {
            "name": "Planificador Antolog√≠as",
            "short_name": "Antolog√≠as",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#121212",
            "theme_color": "#1E1E1E",
            "icons": [
                {
                    "src": iconUrl,
                    "sizes": "192x192",
                    "type": "image/png"
                }
            ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestUrl = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-link').href = manifestUrl;
    };

    // Event Data for Calendar
    const eventData = {
        '2025-07-01': { cat: 'yellow', day: 'Martes', reason: 'Exhibici√≥n de Veh√≠culos. Riesgo clim√°tico medio (temporada lluviosa) y post-quincena. Requiere plan B para lluvia.' },
        '2025-07-04': { cat: 'red', day: 'Viernes', reason: 'Inicio de vacaciones escolares MEP, alto √©xodo de la GAM.' },
        '2025-07-05': { cat: 'red', day: 'S√°bado', reason: 'Inicio de vacaciones escolares MEP, alto √©xodo de la GAM.' },
        '2025-07-11': { cat: 'red', day: 'Viernes', reason: 'Plenas vacaciones escolares MEP, alto √©xodo de la GAM.' },
        '2025-07-12': { cat: 'red', day: 'S√°bado', reason: 'Plenas vacaciones escolares MEP, alto √©xodo de la GAM.' },
        '2025-07-15': { cat: 'blue', day: 'Martes', reason: 'D√≠a de pago de quincena.' },
        '2025-07-18': { cat: 'yellow', day: 'Viernes', reason: 'Fin de vacaciones escolares, posible regreso a la GAM. Cerca de quincena.' },
        '2025-07-19': { cat: 'yellow', day: 'S√°bado', reason: 'Fin de semana post-vacaciones. Competencia de nicho (Stryper).' },
        '2025-07-25': { cat: 'red', day: 'Viernes', reason: 'Feriado (Anexi√≥n de Nicoya), fin de semana largo, alto √©xodo. Competencia: Gandhi Sinf√≥nico.' },
        '2025-07-26': { cat: 'yellow', day: 'S√°bado', reason: 'Fin de semana largo post-quincena. Competencia: Gandhi Sinf√≥nico.' },
        '2025-07-31': { cat: 'blue', day: 'Jueves', reason: 'D√≠a de pago de quincena.' },
        '2025-08-01': { cat: 'red', day: 'Viernes', reason: 'V√≠spera de la Romer√≠a, paralizaci√≥n social y √©xodo hacia Cartago.' },
        '2025-08-02': { cat: 'red', day: 'S√°bado', reason: 'D√≠a de la Virgen de los √Ångeles, Romer√≠a.' },
        '2025-08-05': { cat: 'red', day: 'Martes', reason: 'Exhibici√≥n de Veh√≠culos. Riesgo clim√°tico medio/alto (temporada lluviosa) y posicionado tras el fin de semana de la Romer√≠a, afectando el inter√©s del p√∫blico.' },
        '2025-08-08': { cat: 'yellow', day: 'Viernes', reason: 'Fin de semana regular, alejado de quincena.' },
        '2025-08-09': { cat: 'yellow', day: 'S√°bado', reason: 'Competencia indirecta (p√∫blico joven) en Parque Viva.' },
        '2025-08-15': { cat: 'green', day: 'Viernes', reason: 'D√≠a de la Madre y d√≠a de pago. Alta demanda de celebraciones familiares, superando el riesgo de competencia externa.' },
        '2025-08-16': { cat: 'green', day: 'S√°bado', reason: 'Fin de semana del D√≠a de la Madre. Alta demanda de celebraciones familiares.' },
        '2025-08-22': { cat: 'yellow', day: 'Viernes', reason: 'Fin de semana alejado de la quincena. Poder de compra moderado.' },
        '2025-08-23': { cat: 'yellow', day: 'S√°bado', reason: 'Fin de semana alejado de la quincena. Poder de compra moderado.' },
        '2025-08-29': { cat: 'green', day: 'Viernes', reason: 'Fin de semana de quincena. Oportunidad alta.' },
        '2025-08-30': { cat: 'green', day: 'S√°bado', reason: 'Fin de semana de quincena. Competencia media (Paulo Londra).' },
        '2025-09-02': { cat: 'red', day: 'Martes', reason: 'Exhibici√≥n de Veh√≠culos. Pico de temporada lluviosa (riesgo clim√°tico muy alto). Plan de contingencia es obligatorio.' },
        '2025-09-05': { cat: 'yellow', day: 'Viernes', reason: 'Fin de semana regular.' },
        '2025-09-06': { cat: 'red', day: 'S√°bado', reason: 'Competencia de nicho rock/metal (Cradle of Filth).' },
        '2025-09-12': { 'cat': 'green', 'day': 'Viernes', 'reason': 'Fin de semana de quincena. Oportunidad alta.' },
        '2025-09-13': { 'cat': 'green', 'day': 'S√°bado', 'reason': 'Fin de semana de quincena. Oportunidad alta.' },
        '2025-09-15': { cat: 'blue', day: 'Lunes', reason: 'D√≠a de pago de quincena y feriado (D√≠a de la Independencia).' },
        '2025-09-19': { cat: 'yellow', day: 'Viernes', reason: 'Fin de semana alejado de la quincena.' },
        '2025-09-20': { cat: 'yellow', day: 'S√°bado', reason: 'Fin de semana alejado de la quincena.' },
        '2025-09-26': { cat: 'yellow', day: 'Viernes', reason: 'Fin de semana PREVIO a quincena. Oportunidad media.' },
        '2025-09-27': { cat: 'yellow', day: 'S√°bado', reason: 'Fin de semana PREVIO a quincena. Oportunidad media.' },
        '2025-09-30': { cat: 'blue', day: 'Martes', reason: 'D√≠a de pago de quincena.' },
        '2025-10-03': { cat: 'yellow', day: 'Viernes', reason: 'Competencia indirecta (p√∫blico joven) pero de alto impacto en el mercado general.' },
        '2025-10-04': { cat: 'yellow', day: 'S√°bado', reason: 'Competencia indirecta (p√∫blico joven) pero de alto impacto en el mercado general.' },
        '2025-10-07': { cat: 'red', day: 'Martes', reason: 'Exhibici√≥n de Veh√≠culos. Pico de temporada lluviosa (riesgo clim√°tico muy alto) y posicionado entre fines de semana de conciertos masivos.' },
        '2025-10-10': { cat: 'yellow', day: 'Viernes', reason: 'Fin de semana regular.' },
        '2025-10-11': { cat: 'yellow', day: 'S√°bado', reason: 'Competencia indirecta (p√∫blico joven) pero de alto impacto en el mercado general.' },
        '2025-10-15': { cat: 'blue', day: 'Mi√©rcoles', reason: 'D√≠a de pago de quincena.' },
        '2025-10-17': { cat: 'green', day: 'Viernes', reason: 'Fin de semana de quincena. Oportunidad alta.' },
        '2025-10-18': { cat: 'yellow', day: 'S√°bado', reason: 'Competencia media (Debi Nova en Parque Viva).' },
        '2025-10-24': { cat: 'yellow', day: 'Viernes', reason: 'Fin de semana alejado de la quincena.' },
        '2025-10-25': { cat: 'yellow', day: 'S√°bado', reason: 'Fin de semana alejado de la quincena.' },
        '2025-10-31': { cat: 'green', day: 'Viernes', reason: 'Fin de semana de quincena. Celebraci√≥n de Halloween.' },
        '2025-11-01': { cat: 'green', day: 'S√°bado', reason: 'Fin de semana de quincena. Oportunidad alta.' },
        '2025-11-04': { cat: 'yellow', day: 'Martes', reason: 'Exhibici√≥n de Veh√≠culos. Riesgo clim√°tico medio (transici√≥n a temporada seca). Competencia masiva (Carin Leon) el mismo fin de semana.' },
        '2025-11-07': { cat: 'red', day: 'Viernes', reason: 'Competencia masiva: Carin Leon en Estadio Nacional.' },
        '2025-11-08': { cat: 'red', day: 'S√°bado', reason: 'Competencia masiva: Carin Leon en Estadio Nacional.' },
        '2025-11-14': { cat: 'green', day: 'Viernes', reason: 'Fin de semana de quincena. Oportunidad muy alta.' },
        '2025-11-15': { cat: 'red', day: 'S√°bado', reason: 'Competencia Fuerte: Ana Gabriel en Parque Viva. Alto riesgo por solapamiento de p√∫blico objetivo.' },
        '2025-11-21': { cat: 'yellow', day: 'Viernes', reason: 'Fin de semana alejado de la quincena.' },
        '2025-11-22': { cat: 'yellow', day: 'S√°bado', reason: 'Fin de semana alejado de la quincena.' },
        '2025-11-28': { cat: 'green', day: 'Viernes', reason: 'Inicio de "Ventana Dorada" (post-Viernes Negro, pre-aguinaldo).' },
        '2025-11-29': { cat: 'green', day: 'S√°bado', reason: 'Inicio de "Ventana Dorada". Oportunidad muy alta.' },
        '2025-12-02': { cat: 'green', day: 'Martes', reason: 'Exhibici√≥n de Veh√≠culos. Bajo riesgo clim√°tico (temporada seca) y en plena "Ventana Dorada" con alto poder adquisitivo (aguinaldo).' },
        '2025-12-05': { cat: 'red', day: 'Viernes', reason: 'Competencia masiva: Bad Bunny en Estadio Nacional.' },
        '2025-12-06': { cat: 'red', day: 'S√°bado', reason: 'Competencia masiva: Bad Bunny en Estadio Nacional.' },
        '2025-12-12': { cat: 'green', day: 'Viernes', reason: 'Plena "Ventana Dorada" (aguinaldo). Fin de curso lectivo.' },
        '2025-12-13': { cat: 'green', day: 'S√°bado', reason: 'Plena "Ventana Dorada" (aguinaldo). Oportunidad m√°xima.' },
        '2025-12-15': { cat: 'blue', day: 'Lunes', reason: 'D√≠a de pago de quincena.' },
        '2025-12-19': { cat: 'green', day: 'Viernes', reason: '√öltima gran oportunidad pre-Navidad, pleno apogeo de la "Ventana Dorada".' },
        '2025-12-20': { cat: 'green', day: 'S√°bado', reason: '√öltima gran oportunidad del a√±o.' },
        '2025-12-26': { cat: 'red', day: 'Viernes', reason: 'Fiestas de Zapote en pleno apogeo. √âxodo de fin de a√±o.' },
        '2025-12-27': { cat: 'red', day: 'S√°bado', reason: 'Fiestas de Zapote en pleno apogeo. √âxodo de fin de a√±o.' },
        '2025-12-31': { cat: 'blue', day: 'Mi√©rcoles', reason: 'D√≠a de pago de quincena.' },

        '2026-01-02': { cat: 'red', day: 'Viernes', reason: 'Feriado (jueves 1), "cuesta de enero", Fiestas de Zapote.' },
        '2026-01-03': { cat: 'red', day: 'S√°bado', reason: '"Cuesta de enero", Fiestas de Zapote.' },
        '2026-01-06': { cat: 'red', day: 'Martes', reason: 'Exhibici√≥n de Veh√≠culos. Bajo riesgo clim√°tico, pero en plena "cuesta de enero" y compitiendo con las Fiestas de Palmares.' },
        '2026-01-09': { cat: 'red', day: 'Viernes', reason: 'Inicio Fiestas de Palmares, √©xodo masivo, "cuesta de enero".' },
        '2026-01-10': { cat: 'red', day: 'S√°bado', reason: 'Plenas Fiestas de Palmares, "cuesta de enero".' },
        '2026-01-15': { cat: 'blue', day: 'Jueves', reason: 'D√≠a de pago de quincena.' },
        '2026-01-16': { cat: 'red', day: 'Viernes', reason: 'Plenas Fiestas de Palmares. Post-quincena pero con √©xodo.' },
        '2026-01-17': { cat: 'red', day: 'S√°bado', reason: 'Plenas Fiestas de Palmares.' },
        '2026-01-23': { cat: 'red', day: 'Viernes', reason: '√öltimo fin de semana de Fiestas de Palmares.' },
        '2026-01-24': { cat: 'red', day: 'S√°bado', reason: '√öltimo fin de semana de Fiestas de Palmares.' },
        '2026-01-30': { cat: 'red', day: 'Viernes', reason: 'V√≠spera de Elecciones Nacionales. Alta tensi√≥n pol√≠tica, posible Ley Seca.' },
        '2026-01-31': { cat: 'red', day: 'S√°bado', reason: 'V√≠spera de Elecciones Nacionales. Alta tensi√≥n pol√≠tica, posible Ley Seca.' },
        '2026-02-03': { cat: 'yellow', day: 'Martes', reason: 'Exhibici√≥n de Veh√≠culos. Bajo riesgo clim√°tico, pero en un per√≠odo de bajo consumo (post-elecciones, lejos de quincena).' },
        '2026-02-06': { cat: 'yellow', day: 'Viernes', reason: 'Fin de semana post-elecciones. Ambiente de normalizaci√≥n.' },
        '2026-02-07': { cat: 'yellow', day: 'S√°bado', reason: 'V√≠spera del Super Bowl LX (domingo 8).' },
        '2026-02-13': { cat: 'green', day: 'Viernes', reason: 'Fin de semana de quincena. V√≠spera de San Valent√≠n.' },
        '2026-02-14': { cat: 'green', day: 'S√°bado', reason: 'Fin de semana de quincena. D√≠a de San Valent√≠n.' }
    };

    const analysisContent = [
        { title: 'El Restaurante como Destino: Celebraciones Familiares', content: 'Este es un factor clave que puede anular otros riesgos. Fechas como el D√≠a de la Madre y el D√≠a del Padre son oportunidades de primer nivel (Verde), ya que las familias buscan activamente un lugar especial para celebrar. En estos d√≠as, la competencia externa tiene un impacto menor porque Antolog√≠as no es solo una opci√≥n de ocio, sino el destino principal de la celebraci√≥n.' },
        { title: 'El Pulso Econ√≥mico: Quincenas y Aguinaldo', content: 'El factor m√°s influyente. Los fines de semana que caen en d√≠a de pago o inmediatamente despu√©s son los mejores. El poder de compra disminuisce para el fin de semana siguiente. La "Ventana Dorada" (finales de noviembre a la tercera semana de diciembre) es el pico de gasto anual gracias al aguinaldo.' },
        { title: 'El √âxodo Urbano: Vacaciones y Fines de Semana Largos', content: 'Los feriados que crean fines de semana de 3 d√≠as y las vacaciones escolares (julio y diciembre-febrero) provocan una salida masiva de la poblaci√≥n de la GAM hacia zonas tur√≠sticas, reduciendo dr√°sticamente la audiencia potencial.' },
        { title: 'Las Grandes Fiestas Populares: Competencia Masiva', content: 'Eventos como las Fiestas de Zapote y Palmares son una competencia directa y abrumadora. La Romer√≠a (1-2 de agosto) paraliza la actividad social. Estas fechas son de alt√≠simo riesgo, aunque abren la puerta a la contraprogramaci√≥n.' },
        { title: 'El Fen√≥meno "Sill√≥n-Ball": Eventos Deportivos', content: 'Partidos clave de "La Sele", finales del torneo local y eventos como la final de la Champions League o el Super Bowl mantienen a la audiencia en casa. Dado que sus eventos inician post 8:00 PM, los partidos vespertinos representan un riesgo menor (Amarillo), pues el p√∫blico puede salir despu√©s. Sin embargo, los partidos en horario estelar (post 7:00 PM) siguen siendo un riesgo alto (Rojo) por el conflicto directo.' },
        { title: 'El Escenario Competitivo: La Batalla por la Atenci√≥n', content: 'Mega-conciertos en recintos como el Estadio Nacional o Parque Viva consumen el presupuesto de ocio y la atenci√≥n del mercado para ese fin de semana. Es crucial monitorear los anuncios de nuevos eventos y analizar el solapamiento de audiencias.' },
        { title: 'El Factor Pol√≠tico: Elecciones Nacionales 2026', content: 'Las elecciones generales (1 de febrero y posible segunda ronda el 5 de abril de 2026) dominar√°n la atenci√≥n p√∫blica. Los fines de semana de las elecciones son de nula actividad comercial y deben marcarse como de riesgo m√°ximo.' },
        { title: 'An√°lisis del P√∫blico: Actual vs. Potencial', content: 'Tus datos demogr√°ficos revelan dos perfiles: 1) **P√∫blico Actual (Seguidores):** Un n√∫cleo leal, mayoritariamente femenino (64-71%), con edades entre 35-54 a√±os y concentrado en la GAM. Este perfil valida la estrategia de enfocar esfuerzos en fechas de celebraci√≥n familiar (D√≠a de la Madre/Padre) y quincenas. 2) **P√∫blico Potencial (Alcance):** Un mercado mucho m√°s amplio y joven (25-44 a√±os), con una distribuci√≥n de g√©nero equitativa y presencia nacional. Para atraer a este grupo, se podr√≠an considerar eventos con artistas de g√©neros m√°s actuales o promociones espec√≠ficas para un p√∫blico m√°s joven en fechas de riesgo medio (amarillas).' },
        {
            title: 'An√°lisis de P√∫blico y Competencia',
            content: 'La investigaci√≥n confirma la percepci√≥n inicial: Fiestas como las de Palmares atraen un p√∫blico significativamente m√°s joven (18-35 a√±os) con afinidad por g√©neros urbanos y artistas internacionales, representando un mercado distinto al n√∫cleo del restaurante. En contraste, las fiestas de Zapote se orientan a un p√∫blico m√°s familiar con talento nacional, y las de Santa Cruz a un perfil cultural-folcl√≥rico. Musicalmente, la competencia directa y fuerte para el p√∫blico objetivo (35-54 a√±os) son los conciertos de baladistas y artistas cl√°sicos en espa√±ol (ej. Chayanne, Joaqu√≠n Sabina, Pandora & Flans en 2025). A esto se suman giras de artistas de pop-rock internacionales consolidados (ej. Eros Ramazzotti en nov. 2026) y leyendas del rock (Guns N\' Roses en oct. 2025), que compiten directamente por el mismo segmento demogr√°fico. G√©neros como Reggaet√≥n o Rock Alternativo (ej. Foster the People en nov. 2025), aunque populares, son una competencia indirecta al atraer a un segmento de edad diferente. Finalmente, el an√°lisis pol√≠tico indica una alta probabilidad de una segunda ronda electoral en abril de 2026 debido a la fragmentaci√≥n partidaria hist√≥rica, un factor estrat√©gico clave a considerar para la planificaci√≥n de ese trimestre.'
        }
    ];

    const climateData = [
        { month: 'Enero', risk: 'üü¢', justification: 'Plena temporada seca. Muy baja probabilidad de lluvia. Planificar con confianza.' },
        { month: 'Febrero', risk: 'üü¢', justification: 'Plena temporada seca. Muy baja probabilidad de lluvia. Planificar con confianza.' },
        { month: 'Marzo', risk: 'üü¢', justification: 'Plena temporada seca. Muy baja probabilidad de lluvia. Planificar con confianza.' },
        { month: 'Abril', risk: 'üü¢', justification: 'Final de la temporada seca. El riesgo de lluvia sigue siendo bajo. Planificar con confianza.' },
        { month: 'Mayo', risk: 'üü°', justification: 'Inicio de la temporada lluviosa. Aumenta la probabilidad de aguaceros vespertinos. Tener un Plan B (carpas).' },
        { month: 'Junio', risk: 'üü°', justification: 'Plena temporada lluviosa. Alta probabilidad de lluvias por la tarde/noche. Plan B es esencial.' },
        { month: 'Julio', risk: 'üü°', justification: 'Temporada lluviosa. Posibilidad del "Veranillo de San Juan" pero no es garantizado. Plan B es esencial.' },
        { month: 'Agosto', risk: 'üü°', justification: 'Temporada lluviosa. Mes caracterizado por alta precipitaci√≥n. Plan B es esencial.' },
        { month: 'Septiembre', risk: 'üî¥', justification: 'Pico de la temporada lluviosa. Muy alta probabilidad de lluvia fuerte. Considerar posponer o asegurar cobertura completa.' },
        { month: 'Octubre', risk: 'üî¥', justification: 'Pico de la temporada lluviosa. Muy alta probabilidad de lluvia fuerte. Considerar posponer o asegurar cobertura completa.' },
        { month: 'Noviembre', risk: 'üü°', justification: 'Mes de transici√≥n hacia la temporada seca, pero a√∫n con alta probabilidad de lluvia. Plan B es esencial.' },
        { month: 'Diciembre', risk: 'üü¢', justification: 'Inicio de la temporada seca. La probabilidad de lluvia disminuisce dr√°sticamente. Planificar con confianza.' },
    ];

    let currentYear = 2025;
    let selectedDayElement = null;
    let opportunityChart = null;
    let paydayChart = null; // New chart instance for Paydays
    const calendarsContainer = document.getElementById('calendars-container');
    const detailsContentDesktop = document.getElementById('details-content-desktop');
    const detailsContentMobile = document.getElementById('details-content-mobile');
    const modal = document.getElementById('details-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const themeToggleBtn = document.getElementById('theme-toggle');
    const colorblindToggleBtn = document.getElementById('colorblind-toggle'); // Get the new toggle button
    const body = document.body;


    const views = {
        calendario: document.getElementById('view-calendario'),
        analisis: document.getElementById('view-analisis'),
        estrategias: document.getElementById('view-estrategias'),
        clima: document.getElementById('view-clima'),
    };

    const navButtons = {
        calendario: document.getElementById('nav-calendario'),
        analisis: document.getElementById('nav-analisis'),
        estrategias: document.getElementById('nav-estrategias'),
        clima: document.getElementById('nav-clima'),
    };
    
    function switchView(viewName) {
        Object.values(views).forEach(v => v.classList.add('hidden'));
        Object.values(navButtons).forEach(b => b.classList.replace('nav-active', 'nav-inactive'));
        
        views[viewName].classList.remove('hidden');
        navButtons[viewName].classList.replace('nav-inactive', 'nav-active');
        window.scrollTo(0, 0);
    }

    Object.keys(navButtons).forEach(key => {
        navButtons[key].addEventListener('click', () => switchView(key));
    });

    const getDayClass = (dateString) => {
        const data = eventData[dateString];
        if (data) {
            // These classes are dynamically mapped to the currentActiveColorPalette
            if (data.cat === 'green') return 'bg-green-opportunity';
            if (data.cat === 'yellow') return 'bg-yellow-opportunity';
            if (data.cat === 'red') return 'bg-red-opportunity';
            if (data.cat === 'blue') return 'bg-blue-payday';
        }
        return 'bg-neutral-day';
    };

    const generateCalendar = (year) => {
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const dayNames = ["D", "L", "K", "M", "J", "V", "S"];
        let calendarHTML = `<div id="calendar-grid-${year}" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">`;
        
        const startMonth = (year === 2025) ? 6 : 0;

        for (let month = startMonth; month < 12; month++) {
            calendarHTML += `<div class="p-4 dark-mode-surface rounded-xl shadow-sm">
                <h3 class="font-bold text-center mb-3 text-lg dark-mode-text-header">${monthNames[month]} ${year}</h3>
                <div class="calendar-grid-header text-xs">`;
            dayNames.forEach(day => {
                calendarHTML += `<div class="font-semibold text-center dark-mode-text-accent">${day}</div>`;
            });
            calendarHTML += `</div><div class="calendar-grid text-sm">`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                calendarHTML += `<div class="bg-empty-day rounded-full"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                const dayClass = getDayClass(dateString);
                
                let additionalClasses = "day flex items-center justify-center font-semibold rounded-full cursor-pointer";
                if (dayClass === 'bg-neutral-day') {
                    additionalClasses += " text-gray-400";
                }
                
                calendarHTML += `<div class="${dayClass} ${additionalClasses}" data-date="${dateString}">${day}${eventData[dateString]?.cat === 'green' ? '<span class="priority-star">‚≠ê</span>' : ''}</div>`;
            }
            calendarHTML += `</div></div>`;
        }
        calendarHTML += `</div>`;
        return calendarHTML;
    };
    
    function showDayDetails(dateString) {
        const data = eventData[dateString];
        const date = new Date(dateString + 'T00:00:00');
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = date.toLocaleDateString('es-ES', options);

        let html = `<h4 class="font-bold text-lg text-gray-100 capitalize">${formattedDate}</h4>`; // Text color is adjusted by light/dark mode CSS

        // Adjust text color based on current theme for details panel
        const textColorClass = body.classList.contains('light-mode') ? 'text-gray-700' : 'text-gray-100';
        const mutedTextColorClass = body.classList.contains('light-mode') ? 'text-gray-600' : 'text-gray-300';
        const veryMutedTextColorClass = body.classList.contains('light-mode') ? 'text-gray-500' : 'text-gray-500';

        html = `<h4 class="font-bold text-lg ${textColorClass} capitalize">${formattedDate}</h4>`;
        
        if (data) {
            let emoji, statusText;
            // Determine emoji and status text based on original category, not colorblind mapping
            if(data.cat === 'green') {
                emoji = 'üü¢'; statusText = 'Oportunidad Alta';
            } else if (data.cat === 'yellow') {
                emoji = 'üü°'; statusText = 'Riesgo Medio';
            } else if (data.cat === 'red') {
                emoji = 'üî¥'; statusText = 'Riesgo Alto';
            } else if (data.cat === 'blue') {
                emoji = 'üîµ'; statusText = 'D√≠a de Pago';
            }

            // Use inline style for color to ensure it reflects the active palette correctly
            let detailColor = '';
            if (data.cat === 'green') detailColor = currentActiveColorPalette.opportunityHigh.bg;
            else if (data.cat === 'yellow') detailColor = currentActiveColorPalette.opportunityMedium.bg;
            else if (data.cat === 'red') detailColor = currentActiveColorPalette.opportunityLow.bg;
            else if (data.cat === 'blue') detailColor = currentActiveColorPalette.payday.bg;

            html += `<p class="font-semibold" style="color: ${detailColor};">${emoji} ${statusText}</p>`;
            html += `<p class="text-sm ${mutedTextColorClass} mt-2"><span class="font-semibold">Justificaci√≥n:</span> ${data.reason}</p>`;
        } else {
            const dayOfWeek = date.getDay();
            if (dayOfWeek === 5 || dayOfWeek === 6) {
                 html += `<p class="font-semibold ${mutedTextColorClass}">‚ö™ Oportunidad Neutra</p>`;
                 html += `<p class="text-sm ${veryMutedTextColorClass} mt-2"><span class="font-semibold">Justificaci√≥n:</span> Fin de semana regular sin factores negativos o positivos mayores identificados. Se considera una buena oportunidad base. </p>`;
            } else {
                 html += `<p class="font-semibold ${veryMutedTextColorClass}">D√≠a entre semana</p>`;
                 html += `<p class="text-sm ${veryMutedTextColorClass} mt-2">No se han analizado factores estrat√©gicos espec√≠ficos para esta fecha.</p>`;
            }
        }
        
        if (window.innerWidth < 1024) {
            detailsContentMobile.innerHTML = html;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
            }, 10);
        } else {
            detailsContentDesktop.innerHTML = html;
        }
    }

    function closeModal() {
        modal.classList.add('opacity-0');
        modal.querySelector('div').classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    modalCloseBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });

    calendarsContainer.addEventListener('click', (e) => {
        const dayElement = e.target.closest('.day');
        if (dayElement) {
            const date = dayElement.dataset.date;
            if (selectedDayElement) {
                selectedDayElement.classList.remove('selected');
            }
            dayElement.classList.add('selected');
            selectedDayElement = dayElement;
            showDayDetails(date);
        }
    });

    // Function to update the styles of the year buttons based on active year and theme
    function updateYearButtonStyles() {
        const year2025Btn = document.getElementById('year-2025');
        const year2026Btn = document.getElementById('year-2026');
        const isLightMode = body.classList.contains('light-mode');

        // Clear all year-button specific classes first
        year2025Btn.classList.remove('year-btn-active-dark', 'year-btn-inactive-dark', 'year-btn-active-light', 'year-btn-inactive-light');
        year2026Btn.classList.remove('year-btn-active-dark', 'year-btn-inactive-dark', 'year-btn-active-light', 'year-btn-inactive-light');
        
        // Apply classes based on current year and theme
        if (currentYear === 2025) {
            year2025Btn.classList.add(isLightMode ? 'year-btn-active-light' : 'year-btn-active-dark');
            year2026Btn.classList.add(isLightMode ? 'year-btn-inactive-light' : 'year-btn-inactive-dark');
        } else { // currentYear === 2026
            year2026Btn.classList.add(isLightMode ? 'year-btn-active-light' : 'year-btn-active-dark');
            year2025Btn.classList.add(isLightMode ? 'year-btn-inactive-light' : 'year-btn-inactive-dark');
        }
    }

    function updateActiveYear(year) {
        currentYear = year;
        document.getElementById('calendar-grid-2025').classList.toggle('hidden', year !== 2025);
        document.getElementById('calendar-grid-2026').classList.toggle('hidden', year !== 2026);
        
        detailsContentDesktop.innerHTML = '<p class="text-center dark-mode-text-muted pt-8">Selecciona una fecha en el calendario.</p>';
        if(selectedDayElement) {
            selectedDayElement.classList.remove('selected');
            selectedDayElement = null;
        }

        updateYearButtonStyles(); // Update button styles
        updateChartColors(); // Call to update chart colors based on current theme
        createPaydayChart(); // Re-create payday chart as well
    }
    
    document.getElementById('year-2025').addEventListener('click', () => updateActiveYear(2025));
    document.getElementById('year-2026').addEventListener('click', () => updateActiveYear(2026));
    document.getElementById('print-btn').addEventListener('click', () => window.print());

    const filterButtons = document.querySelectorAll('.filter-btn');
    const filterButtonLabels = { // Map original filter data-filter to display text
        'all': 'Todos',
        'green': 'Verdes',
        'yellow': 'Amarillos',
        'red': 'Rojos',
        'blue': 'D√≠as de Pago'
    };
    const colorblindFilterButtonLabels = { // Map for colorblind mode
        'all': 'Todos',
        'green': 'P√∫rpuras', // Changed from Verdes
        'yellow': 'Amarillos',
        'red': 'Naranjas', // Changed from Rojos
        'blue': 'D√≠as de Pago'
    };

    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            filterButtons.forEach(btn => {
                btn.classList.remove('filter-btn-active');
                // Remove specific dark mode background if it was applied
                btn.classList.remove('bg-[#383838]'); 
                // Add default background, which will be overridden by light-mode if active
                if (!body.classList.contains('light-mode')) {
                    btn.classList.add('bg-[#383838]'); 
                }
            });
            button.classList.add('filter-btn-active');
            filterCalendar(button.dataset.filter);
        });
    });

    function updateFilterButtonLabels() {
        const labelsToUse = isColorblindMode ? colorblindFilterButtonLabels : filterButtonLabels;
        filterButtons.forEach(button => {
            const dataFilter = button.dataset.filter;
            button.innerHTML = `<span>${labelsToUse[dataFilter]}</span>`; // Update text content
        });
    }

    function filterCalendar(category) {
        const allDays = document.querySelectorAll('.day');
        allDays.forEach(day => {
            day.classList.remove('day-filtered');
            if (category === 'all') return;

            let dayCategory = '';
            if (day.classList.contains('bg-green-opportunity')) dayCategory = 'green';
            else if (day.classList.contains('bg-yellow-opportunity')) dayCategory = 'yellow';
            else if (day.classList.contains('bg-red-opportunity')) dayCategory = 'red';
            else if (day.classList.contains('bg-blue-payday')) dayCategory = 'blue';
            
            if (category !== dayCategory) {
                day.classList.add('day-filtered');
            }
        });
    }

    function countOpportunities(year) {
        const counts = { green: 0, yellow: 0, red: 0 };
        for (const dateString in eventData) {
            if (dateString.startsWith(year)) {
                const date = new Date(dateString + 'T00:00:00');
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 5 || dayOfWeek === 6) { 
                    if (eventData[dateString].cat === 'green') counts.green++;
                    if (eventData[dateString].cat === 'yellow') counts.yellow++;
                    if (eventData[dateString].cat === 'red') counts.red++;
                }
            }
        }
        return counts;
    }

    // Function to count payday events
    function countPaydays(year) {
        let count = 0;
        for (const dateString in eventData) {
            if (dateString.startsWith(year) && eventData[dateString].cat === 'blue') {
                count++;
            }
        }
        return count;
    }

    // Function to update chart colors based on the current theme
    function updateChartColors() {
        if (!opportunityChart) return;

        const isLightMode = body.classList.contains('light-mode');

        const gridColor = isLightMode ? '#BBBBBB' : '#444444';
        const tickColor = isLightMode ? '#333333' : '#E0E0E0';
        const labelColor = isLightMode ? '#333333' : '#E0E0E0';
        const tooltipBg = isLightMode ? '#FFFFFF' : '#121212';
        const tooltipBorder = isLightMode ? '#CCCCCC' : '#444444';
        const tooltipColor = isLightMode ? '#333333' : '#E0E0E0';

        // Update grid and tick colors for opportunityChart
        opportunityChart.options.scales.y.grid.color = gridColor;
        opportunityChart.options.scales.y.ticks.color = tickColor;
        opportunityChart.options.scales.y.title.color = labelColor;
        opportunityChart.options.scales.x.ticks.color = tickColor;

        // Update legend and tooltip colors for opportunityChart
        opportunityChart.options.plugins.legend.labels.color = labelColor;
        opportunityChart.options.plugins.tooltip.backgroundColor = tooltipBg;
        opportunityChart.options.plugins.tooltip.borderColor = tooltipBorder;
        opportunityChart.options.plugins.tooltip.titleColor = tooltipColor;
        opportunityChart.options.plugins.tooltip.bodyColor = tooltipColor;

        // Update bar colors based on active year and theme for opportunityChart
        const activeColor = isLightMode ? '#6D5D4B' : '#A99D8B'; // Adjusted for light mode
        const inactiveColor = isLightMode ? '#AAAAAA' : '#555555';
        const activeBorder = isLightMode ? '#4A3D30' : '#6D5D4B';
        const inactiveBorder = isLightMode ? '#888888' : '#888888';

        opportunityChart.data.datasets[0].backgroundColor = currentYear === 2025 ? activeColor : inactiveColor;
        opportunityChart.data.datasets[0].borderColor = currentYear === 2025 ? activeBorder : inactiveBorder;
        
        opportunityChart.data.datasets[1].backgroundColor = currentYear === 2026 ? activeColor : inactiveColor;
        opportunityChart.data.datasets[1].borderColor = currentYear === 2026 ? activeBorder : inactiveBorder;
        
        opportunityChart.update();

        // Update colors for paydayChart if it exists
        if (paydayChart) {
            paydayChart.options.scales.y.grid.color = gridColor;
            paydayChart.options.scales.y.ticks.color = tickColor;
            paydayChart.options.scales.y.title.color = labelColor;
            paydayChart.options.scales.x.ticks.color = tickColor;
            paydayChart.options.plugins.legend.labels.color = labelColor;
            paydayChart.options.plugins.tooltip.backgroundColor = tooltipBg;
            paydayChart.options.plugins.tooltip.borderColor = tooltipBorder;
            paydayChart.options.plugins.tooltip.titleColor = tooltipColor;
            paydayChart.options.plugins.tooltip.bodyColor = tooltipColor;

            // Update bar colors for paydayChart
            paydayChart.data.datasets[0].backgroundColor = currentYear === 2025 ? currentActiveColorPalette.payday.bg : inactiveColor;
            paydayChart.data.datasets[0].borderColor = currentYear === 2025 ? currentActiveColorPalette.payday.bg : inactiveBorder;
            paydayChart.data.datasets[1].backgroundColor = currentYear === 2026 ? currentActiveColorPalette.payday.bg : inactiveColor;
            paydayChart.data.datasets[1].borderColor = currentYear === 2026 ? currentActiveColorPalette.payday.bg : inactiveBorder;
            paydayChart.update();
        }
    }

    function createChart() {
        const ctx = document.getElementById('opportunityChart').getContext('2d');
        const counts2025 = countOpportunities('2025');
        const counts2026 = countOpportunities('2026');
        
        opportunityChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['üü¢ Oportunidad Alta', 'üü° Riesgo Medio', 'üî¥ Riesgo Alto'],
                datasets: [
                    {
                        label: '2025',
                        data: [counts2025.green, counts2025.yellow, counts2025.red],
                        borderWidth: 2,
                        borderRadius: 5,
                    },
                    {
                        label: '2026',
                        data: [counts2026.green, counts2026.yellow, counts2026.red],
                        borderWidth: 2,
                        borderRadius: 5,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#444444' // Default dark mode color
                        },
                        ticks: {
                           stepSize: 5,
                           color: '#E0E0E0' // Default dark mode color
                        },
                        title: {
                            display: true,
                            text: 'N√∫mero de Viernes y S√°bados',
                            font: { size: 14 },
                            color: '#E0E0E0' // Default dark mode color
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#E0E0E0' // Default dark mode color
                        }
                    }
                },
                plugins: {
                     legend: {
                        position: 'top',
                        labels: {
                            color: '#E0E0E0' // Default dark mode color
                        }
                     },
                     tooltip: {
                        backgroundColor: '#121212', // Default dark mode color
                        titleFont: { size: 16 },
                        bodyFont: { size: 14 },
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) { label += context.parsed.y + ' d√≠as'; }
                                return label;
                            }
                        }
                    }
                }
            }
        });
        // updateChartColors(); // Initial call to set colors based on current theme, now handled by updateActiveYear
    }

    // New function to create the Payday chart
    function createPaydayChart() {
        const ctx = document.getElementById('paydayChart').getContext('2d');
        const paydays2025 = countPaydays('2025');
        const paydays2026 = countPaydays('2026');

        if (paydayChart) {
            paydayChart.destroy(); // Destroy existing chart instance if it exists
        }
        
        paydayChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['üîµ D√≠as de Pago'],
                datasets: [
                    {
                        label: '2025',
                        data: [paydays2025],
                        backgroundColor: currentActiveColorPalette.payday.bg, // Use dynamic color
                        borderColor: currentActiveColorPalette.payday.bg, // Use dynamic color
                        borderWidth: 2,
                        borderRadius: 5,
                    },
                    {
                        label: '2026',
                        data: [paydays2026],
                        backgroundColor: currentActiveColorPalette.payday.bg, // Use dynamic color
                        borderColor: currentActiveColorPalette.payday.bg, // Use dynamic color
                        borderWidth: 2,
                        borderRadius: 5,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#444444'
                        },
                        ticks: {
                           stepSize: 1, // Paydays are typically fewer, so smaller step size
                           color: '#E0E0E0'
                        },
                        title: {
                            display: true,
                            text: 'N√∫mero de D√≠as de Pago',
                            font: { size: 14 },
                            color: '#E0E0E0'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#E0E0E0'
                        }
                    }
                },
                plugins: {
                     legend: {
                        position: 'top',
                        labels: {
                            color: '#E0E0E0'
                        }
                     },
                     tooltip: {
                        backgroundColor: '#121212',
                        titleFont: { size: 16 },
                        bodyFont: { size: 14 },
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) { label += context.parsed.y + ' d√≠as'; }
                                return label;
                            }
                        }
                    }
                }
            }
        });
        // updateChartColors(); // Initial call to set colors, handled by updateActiveYear
    }

    function createAccordion() {
        const container = document.getElementById('accordion-container');
        let html = '';
        analysisContent.forEach((item) => {
            html += `
                <div class="border dark-mode-border rounded-lg">
                    <button class="accordion-button w-full flex justify-between items-center text-left p-4 bg-[#383838] hover:bg-[#444444] rounded-lg transition-colors duration-300">
                        <span class="font-semibold text-lg dark-mode-text-header">${item.title}</span>
                        <svg class="w-6 h-6 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content dark-mode-surface rounded-b-lg px-4">
                        <p class="dark-mode-text-muted py-4">${item.content}</p>
                    </div>
                </div>`;
        });
        container.innerHTML = html;

        container.querySelectorAll('.accordion-button').forEach(button => {
            button.addEventListener('click', () => {
                const content = button.nextElementSibling;
                const icon = button.querySelector('svg');
                
                const isOpening = !content.style.maxHeight || content.style.maxHeight === '0px'; // Check for '0px' too

                // Close all other accordions
                container.querySelectorAll('.accordion-content').forEach(c => c.style.maxHeight = null);
                container.querySelectorAll('.accordion-button svg').forEach(i => i.style.transform = 'rotate(0deg)');
                
                // Open the clicked accordion if it was closed
                if (isOpening) {
                    content.style.maxHeight = content.scrollHeight + "px";
                    icon.style.transform = 'rotate(180deg)';
                }
            });
        });
    }

    function createClimateTable() {
        const tableBody = document.querySelector('#climate-table tbody');
        let html = '';
        climateData.forEach(item => {
            let riskClass = '';
            // These classes are already defined with specific colors and backgrounds
            // and will be overridden by light-mode CSS if active.
            // For colorblind mode, these will map to the currentActiveColorPalette
            if (item.risk === 'üü¢') riskClass = 'text-green-300 bg-green-900';
            if (item.risk === 'üü°') riskClass = 'text-yellow-300 bg-yellow-900';
            if (item.risk === 'üî¥') riskClass = 'text-red-300 bg-red-900';

            html += `
                <tr class="border-b dark-mode-border">
                    <th scope="row" class="px-6 py-4 font-medium text-gray-100 whitespace-nowrap">${item.month}</th>
                    <td class="px-6 py-4"><span class="font-bold px-2 py-1 rounded-full ${riskClass}">${item.risk}</span></td>
                    <td class="px-6 py-4">${item.justification}</td>
                </tr>
            `;
        });
        tableBody.innerHTML = html;
    }

    // =================================================================================
    // THEME TOGGLE LOGIC
    // =================================================================================
    let isLightMode = localStorage.getItem('theme') === 'light';
    let isColorblindMode = localStorage.getItem('colorblind') === 'true';

    const applyTheme = (lightMode) => {
        if (lightMode) {
            body.classList.add('light-mode');
            themeToggleBtn.textContent = 'üåô'; // Moon icon for dark mode
        } else {
            body.classList.remove('light-mode');
            themeToggleBtn.textContent = '‚òÄÔ∏è'; // Sun icon for light mode
        }
        // Reapply filter button styles based on new theme
        filterButtons.forEach(btn => {
            btn.classList.remove('bg-[#383838]'); // Remove dark mode specific background
            if (!lightMode && !btn.classList.contains('filter-btn-active')) {
                btn.classList.add('bg-[#383838]'); 
            }
        });
        updateYearButtonStyles(); // Update year button styles when theme changes
        updateChartColors(); // Update chart colors whenever theme changes
    };

    // Function to update colorblind mode
    const updateColorblindMode = (enable) => {
        isColorblindMode = enable;
        localStorage.setItem('colorblind', enable);
        currentActiveColorPalette = enable ? colorblindColorPalette : defaultColorPalette;
        injectColorStyles(currentActiveColorPalette); // Re-inject styles for the new palette
        
        // Re-render calendar and climate table to apply new colors
        calendarsContainer.innerHTML = generateCalendar(2025) + generateCalendar(2026);
        document.getElementById('calendar-grid-2026').classList.add('hidden'); // Ensure correct year is hidden
        createClimateTable(); // Re-create table with new colors
        updateActiveYear(currentYear); // Re-apply year button styles and chart colors
        updateFilterButtonLabels(); // Update filter button labels
        
        // Update toggle button text/icon
        colorblindToggleBtn.textContent = isColorblindMode ? 'üé®' : 'üåà'; // Paint palette for active CB mode, rainbow for default
    };


    // Set initial themes on load
    applyTheme(isLightMode); // Apply light/dark mode first
    updateColorblindMode(isColorblindMode); // Then apply colorblind mode, which will also re-render colors

    themeToggleBtn.addEventListener('click', () => {
        isLightMode = !isLightMode;
        localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
        applyTheme(isLightMode);
    });

    colorblindToggleBtn.addEventListener('click', () => {
        updateColorblindMode(!isColorblindMode);
    });


    // Initialize the application
    setupPwaAssets();
    // injectColorStyles is now called by applyTheme and updateColorblindMode
    // calendarsContainer.innerHTML = generateCalendar(2025) + generateCalendar(2026); // This is now called by updateColorblindMode
    // document.getElementById('calendar-grid-2026').classList.add('hidden'); // This is now called by updateColorblindMode
    
    createAccordion();
    // createClimateTable(); // This is now called by updateColorblindMode
    createChart(); // Create the main opportunity chart
    createPaydayChart(); // Create the new payday chart
    updateActiveYear(2025); // This will call updateYearButtonStyles() and updateChartColors() for both charts
});
</script>
</body>
</html>
