<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador Antolog√≠as 2026 (Din√°mico)</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#A99D8B">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .nav-active {
            background-color: #A99D8B;
            color: #121212;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .nav-inactive {
            background-color: #2C2C2C;
            color: #A0A0A0;
        }
        .calendar-grid-header, .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            padding: 0 0.5rem;
        }
        .day {
            aspect-ratio: 1 / 1;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .day:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .day.selected {
            box-shadow: 0 0 0 3px #A99D8B;
            z-index: 20;
        }
        .bg-neutral-day { background-color: #383838; }
        .bg-empty-day { background-color: transparent; }
        .priority-star {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 0 2px black;
        }
        
        /* Dynamic Colors Classes */
        .dark-mode-bg { background-color: #1E1E1E; }
        .dark-mode-surface { background-color: #2C2C2C; }
        
        body.light-mode {
            background-color: #F0F0F0;
            color: #333333;
        }
        body.light-mode .dark-mode-surface { background-color: #FFFFFF; }
        body.light-mode .nav-inactive { background-color: #E0E0E0; color: #555555; }
        body.light-mode .bg-neutral-day { background-color: #F5F5F5; color: #555555; }
        
        /* Strategy Cards */
        :root {
            --strategy-green-bg: rgba(46, 125, 50, 0.2);
            --strategy-green-border: #2E7D32;
            --strategy-yellow-bg: rgba(255, 193, 7, 0.2);
            --strategy-yellow-border: #FFC107;
            --strategy-red-bg: rgba(198, 40, 40, 0.2);
            --strategy-red-border: #C62828;
        }
        body.light-mode {
            --strategy-green-bg: #E8F5E9;
            --strategy-yellow-bg: #FFFDE7;
            --strategy-red-bg: #FFEBEE;
        }
        .strategy-card[data-category="green"] { background-color: var(--strategy-green-bg); border-left: 4px solid var(--strategy-green-border); }
        .strategy-card[data-category="yellow"] { background-color: var(--strategy-yellow-bg); border-left: 4px solid var(--strategy-yellow-border); }
        .strategy-card[data-category="red"] { background-color: var(--strategy-red-bg); border-left: 4px solid var(--strategy-red-border); }

        /* Buttons */
        .year-btn-active-dark { background-color: #A99D8B !important; color: #121212 !important; }
        .year-btn-inactive-dark { background-color: #2C2C2C !important; color: #A0A0A0 !important; }
        .year-btn-active-light { background-color: #C3B8A8 !important; color: #FFFFFF !important; }
        .year-btn-inactive-light { background-color: #E0E0E0 !important; color: #555555 !important; }
        
        .filter-btn-active {
            background-color: #8C7B6C !important;
            color: white !important;
        }
        .day-filtered { opacity: 0.15; pointer-events: none; }
        
        @media print {
            body * { visibility: hidden; }
            #calendars-container, #calendars-container * { visibility: visible; }
            #calendars-container { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="dark-mode-text antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-screen-2xl">
        <header class="text-center mb-8 flex flex-col sm:flex-row justify-between items-center">
            <div class="flex flex-col items-center sm:items-start flex-grow">
                <h1 class="text-3xl md:text-5xl font-bold dark-mode-text-header">Planificador Oficial 2025-2026</h1>
                <p class="text-lg dark-mode-text-accent mt-2">Antolog√≠as CR | Estrategia Din√°mica</p>
            </div>
            <div class="flex space-x-2 mt-4 sm:mt-0 sm:ml-4">
                <button id="theme-toggle" class="px-4 py-2.5 text-lg bg-gray-700 text-gray-200 font-semibold rounded-lg hover:bg-gray-600 transition-all duration-300">‚òÄÔ∏è</button>
                <button id="colorblind-toggle" class="px-4 py-2.5 text-lg bg-gray-700 text-gray-200 font-semibold rounded-lg hover:bg-gray-600 transition-all duration-300">üåà</button>
            </div>
        </header>

        <nav class="flex flex-wrap justify-center mb-8 dark-mode-surface rounded-full p-1 max-w-xl mx-auto shadow-inner">
            <button id="nav-calendario" class="nav-btn nav-active flex-1 py-2 px-4 rounded-full text-sm sm:text-base font-semibold transition-all duration-300">üìÖ Calendario</button>
            <button id="nav-analisis" class="nav-btn nav-inactive flex-1 py-2 px-4 rounded-full text-sm sm:text-base font-semibold transition-all duration-300">üîç An√°lisis</button>
            <button id="nav-estrategias" class="nav-btn nav-inactive flex-1 py-2 px-4 rounded-full text-sm sm:text-base font-semibold transition-all duration-300">üí° Estrategias</button>
            <button id="nav-clima" class="nav-btn nav-inactive flex-1 py-2 px-4 rounded-full text-sm sm:text-base font-semibold transition-all duration-300">üå¶Ô∏è Clima</button>
        </nav>

        <main id="main-content">
            <!-- CALENDAR VIEW -->
            <div id="view-calendario">
                <p class="text-center dark-mode-text-muted mb-6 max-w-3xl mx-auto">
                    Los fines de semana de quincena se marcan autom√°ticamente como <span class="text-green-500 font-bold">Oportunidad Alta</span>. 
                    <br><span class="text-amber-500 text-sm font-bold">NOTA: En Enero aplica la "Regla de la Cuesta": Todo riesgo aumenta un nivel.</span>
                </p>
                <div class="flex justify-center items-center mb-6 space-x-4">
                    <button id="year-2025-btn" class="year-btn px-8 py-2.5 text-lg font-semibold rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">Cierre 2025</button>
                    <button id="year-2026-btn" class="year-btn px-8 py-2.5 text-lg font-semibold rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">A√±o 2026</button>
                    <button id="print-btn" class="px-4 py-2.5 text-lg bg-gray-700 text-gray-200 font-semibold rounded-lg hover:bg-gray-600">üñ®Ô∏è</button>
                </div>
                
                <div class="flex flex-wrap justify-center items-center gap-x-4 sm:gap-x-6 gap-y-2 mb-4 text-xs sm:text-sm text-gray-700">
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-opportunity mr-2 border border-gray-400"></span>Oportunidad Alta</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-yellow-opportunity mr-2 border border-gray-400"></span>Riesgo Medio</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-red-opportunity mr-2 border border-gray-400"></span>Riesgo Alto</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-blue-payday mr-2 border border-gray-400"></span>D√≠a de Pago</div>
                </div>

                <div id="filter-container" class="flex flex-wrap justify-center items-center gap-2 mb-8 p-2 dark-mode-surface rounded-full max-w-2xl mx-auto">
                    <button class="filter-btn flex-1 py-1 px-3 text-xs sm:text-sm rounded-full" data-filter="all">Todos</button>
                    <button class="filter-btn flex-1 py-1 px-3 text-xs sm:text-sm rounded-full bg-[#383838]" data-filter="green">üü¢ Verdes</button>
                    <button class="filter-btn flex-1 py-1 px-3 text-xs sm:text-sm rounded-full bg-[#383838]" data-filter="yellow">üü° Amarillos</button>
                    <button class="filter-btn flex-1 py-1 px-3 text-xs sm:text-sm rounded-full bg-[#383838]" data-filter="red">üî¥ Rojos</button>
                    <button class="filter-btn flex-1 py-1 px-3 text-xs sm:text-sm rounded-full bg-[#383838]" data-filter="blue">üîµ Pagos</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div id="calendars-container" class="lg:col-span-8">
                        <!-- Calendar Grids injected via JS -->
                    </div>

                    <div id="details-panel" class="hidden lg:block lg:col-span-4 p-6 dark-mode-surface rounded-2xl shadow-lg self-start sticky top-8">
                        <h3 class="font-bold text-xl mb-4 dark-mode-text-header">Detalles y Estrategia</h3>
                        <div id="details-content-desktop" class="dark-mode-text-muted space-y-3 min-h-[150px]">
                            <p class="text-center dark-mode-text-muted pt-8 opacity-75">Selecciona una fecha para ver el an√°lisis y medidas de contingencia.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ANALYSIS VIEW -->
            <div id="view-analisis" class="hidden">
                 <div class="max-w-4xl mx-auto p-4 md:p-8 dark-mode-surface rounded-2xl shadow-lg">
                    <h2 class="text-2xl md:text-3xl font-bold text-center mb-4 dark-mode-text-header">An√°lisis de Entorno 2026</h2>
                    <div class="space-y-4" id="accordion-container">
                        <!-- Accordion items injected -->
                    </div>
                </div>
            </div>

            <!-- STRATEGIES VIEW -->
            <div id="view-estrategias" class="hidden">
                 <div class="max-w-6xl mx-auto">
                    <h2 class="text-2xl md:text-3xl font-bold text-center mb-4 dark-mode-text-header">Matriz de Contingencia</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
                        <div id="strategy-card-green" class="strategy-card p-6 rounded-lg shadow-md" data-category="green">
                            <h3 id="strategy-green-title" class="font-bold text-xl mb-3 flex items-center"><span class="text-3xl mr-3">üü¢</span> Ofensiva (Fines de Quincena)</h3>
                            <p class="text-sm mb-3 italic">Cuando hay liquidez en el mercado.</p>
                            <ul class="list-disc list-inside space-y-2 text-sm">
                                <li>Eventos "Premium" con cover o consumo m√≠nimo.</li>
                                <li>Promociones de botellas enteras.</li>
                                <li>M√∫sica en vivo de alta energ√≠a.</li>
                                <li><strong>Especiales:</strong> D√≠a de la Madre, Padre, San Valent√≠n.</li>
                            </ul>
                        </div>
                        <div id="strategy-card-yellow" class="strategy-card p-6 rounded-lg shadow-md" data-category="yellow">
                            <h3 class="font-bold text-xl mb-3 flex items-center"><span class="text-3xl mr-3">üü°</span> Defensiva (Fines Regulares)</h3>
                            <p class="text-sm mb-3 italic">Cuando el presupuesto es limitado.</p>
                            <ul class="list-disc list-inside space-y-2 text-sm">
                                <li>Promociones 2x1 en cocteler√≠a y cerveza.</li>
                                <li>Eventos de nicho o entrada gratuita.</li>
                                <li>Enfoque en fidelizaci√≥n de clientes locales.</li>
                                <li><strong>Enero:</strong> Men√∫s econ√≥micos por "Cuesta de Enero".</li>
                            </ul>
                        </div>
                         <div id="strategy-card-red" class="strategy-card p-6 rounded-lg shadow-md" data-category="red">
                            <h3 id="strategy-red-title" class="font-bold text-xl mb-3 flex items-center"><span class="text-3xl mr-3">üî¥</span> Contra-programaci√≥n</h3>
                             <p class="text-sm mb-3 italic">Cuando hay un "Goliath" o Crisis.</p>
                             <ul class="list-disc list-inside space-y-2 text-sm">
                                <li><strong>Si hay Rock:</strong> Ofrecer Noche Latina/Salsa.</li>
                                <li><strong>Si hay Urbano:</strong> Ofrecer Trova/Rock Cl√°sico.</li>
                                <li><strong>Si hay Caos Vial:</strong> Promocionar "After-Party".</li>
                                <li><strong>Enero:</strong> Minimizar inventario perecedero.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CLIMATE VIEW -->
            <div id="view-clima" class="hidden">
                <div class="max-w-4xl mx-auto p-4 md:p-8 dark-mode-surface rounded-2xl shadow-lg pt-6 md:pt-8">
                    <h2 class="text-2xl md:text-3xl font-bold text-center mb-4 dark-mode-text-header">Riesgo Clim√°tico</h2>
                    <div class="overflow-x-auto">
                        <table id="climate-table" class="w-full text-sm text-left dark-mode-text-muted">
                           <thead class="text-xs dark-mode-text-header uppercase bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 rounded-l-lg">Mes</th>
                                    <th scope="col" class="px-6 py-3">Riesgo</th>
                                    <th scope="col" class="px-6 py-3 rounded-r-lg">Estrategia</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Climate data injected -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Modal -->
    <div id="details-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="dark-mode-surface rounded-2xl shadow-2xl p-6 w-full max-w-sm mx-auto transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl dark-mode-text-header">Detalles</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div id="details-content-mobile" class="dark-mode-text-muted space-y-3"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const defaultColorPalette = {
        opportunityHigh: { bg: '#2E7D32', text: '#FFFFFF' },
        opportunityMedium: { bg: '#FFC107', text: '#3D3B38' },
        opportunityLow: { bg: '#C62828', text: '#FFFFFF' },
        payday: { bg: '#1565C0', text: '#FFFFFF' }
    };

    const colorblindColorPalette = {
        opportunityHigh: { bg: '#9933CC', text: '#FFFFFF' },
        opportunityMedium: { bg: '#FFC107', text: '#3D3B38' },
        opportunityLow: { bg: '#FF6600', text: '#FFFFFF' },
        payday: { bg: '#1565C0', text: '#FFFFFF' }
    };

    let currentActiveColorPalette = defaultColorPalette;
    let currentViewYear = '2025-end'; 
    let selectedDayElement = null;
    let isLightMode = localStorage.getItem('theme') === 'light';
    let isColorblindMode = localStorage.getItem('colorblind') === 'true';

    // DOM Elements
    const calendarsContainer = document.getElementById('calendars-container');
    const detailsContentDesktop = document.getElementById('details-content-desktop');
    const detailsContentMobile = document.getElementById('details-content-mobile');
    const modal = document.getElementById('details-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const themeToggleBtn = document.getElementById('theme-toggle');
    const colorblindToggleBtn = document.getElementById('colorblind-toggle');
    const body = document.body;
    const views = {
        calendario: document.getElementById('view-calendario'),
        analisis: document.getElementById('view-analisis'),
        estrategias: document.getElementById('view-estrategias'),
        clima: document.getElementById('view-clima'),
    };
    const navButtons = {
        calendario: document.getElementById('nav-calendario'),
        analisis: document.getElementById('nav-analisis'),
        estrategias: document.getElementById('nav-estrategias'),
        clima: document.getElementById('nav-clima'),
    };
    const filterButtons = document.querySelectorAll('.filter-btn');

    // ============================================================================
    // DATA - EVENTOS FIJOS (Overrides)
    // ============================================================================
    const fixedEvents = {
        // --- DICIEMBRE 2025 ---
        '2025-12-02': { cat: 'yellow', reason: 'Concierto Limp Bizkit (Parque Viva).', contingency: 'Contra-programaci√≥n: Noche Latina / Bailable.' },
        '2025-12-05': { cat: 'red', reason: 'BAD BUNNY (Estadio Nacional). Caos vial Sabana.', contingency: 'Enfoque: After-Party para el p√∫blico que sale del concierto.' },
        '2025-12-06': { cat: 'red', reason: 'BAD BUNNY (Estadio Nacional). 2da Fecha.', contingency: 'Enfoque: After-Party. Evitar m√∫sica urbana para no competir.' },
        '2025-12-25': { cat: 'red', reason: 'Navidad + Zapote.', contingency: 'Cerrado o Men√∫ Navide√±o familiar.' },
        '2025-12-26': { cat: 'red', reason: 'Tope Nacional.', contingency: 'Dif√≠cil acceso. Promociones agresivas para locales a pie.' },
        '2025-12-31': { cat: 'yellow', reason: 'Fin de A√±o.', contingency: 'Solo reservas prepagadas.' },

        // --- ENERO 2026 ---
        '2026-01-01': { cat: 'red', reason: 'A√±o Nuevo.', contingency: 'Cerrado.' },
        '2026-01-16': { cat: 'red', reason: 'Inicio Palmares (√âxodo).', contingency: 'Atraer al p√∫blico adulto mayor que no va a fiestas c√≠vicas.' },
        '2026-01-17': { cat: 'red', reason: 'Fiestas Palmares.', contingency: 'Atraer al p√∫blico adulto mayor.' },
        '2026-01-24': { cat: 'red', reason: 'Cierre Palmares.', contingency: 'Atraer al p√∫blico adulto mayor.' },
        '2026-01-31': { cat: 'red', reason: 'VEDA ELECTORAL (Ley Seca probable).', contingency: 'Cero alcohol. Enfocarse en gastronom√≠a y caf√©.' },

        // --- FEBRERO 2026 ---
        '2026-02-01': { cat: 'red', reason: 'ELECCIONES NACIONALES.', contingency: 'Ley Seca. Men√∫ de Almuerzo familiar post-voto.' },
        '2026-02-07': { cat: 'yellow', reason: 'Viva los 90s Fest (Parque Viva).', contingency: 'Contra-programaci√≥n: Rock en Espa√±ol o Plancha.' },
        '2026-02-14': { cat: 'green', reason: 'San Valent√≠n. Demanda M√°xima Parejas.', contingency: 'Reservas obligatorias. Men√∫ rom√°ntico.' },
        '2026-02-28': { cat: 'red', reason: 'X-Knights (Estadio Nacional).', contingency: 'Ambiente tranquilo/ac√∫stico para quienes huyen del ruido.' },

        // --- MARZO 2026 ---
        '2026-03-18': { cat: 'yellow', reason: 'Tyler, The Creator (Parque Viva).', contingency: 'P√∫blico muy joven. No afecta target adulto.' },
        '2026-03-25': { cat: 'yellow', reason: 'THE KILLERS (Parque Viva).', contingency: 'Contra-programaci√≥n: Noche de Salsa/Merengue.' },
        '2026-03-28': { cat: 'red', reason: 'Inicio Semana Santa (√âxodo).', contingency: 'Reducir inventario perecedero.' },

        // --- ABRIL 2026 ---
        '2026-04-02': { cat: 'red', reason: 'Jueves Santo.', contingency: 'Cerrado o men√∫ mariscos.' },
        '2026-04-03': { cat: 'red', reason: 'Viernes Santo (Ley Seca).', contingency: 'Cerrado.' },
        '2026-04-05': { cat: 'red', reason: 'Posible 2da Ronda Electoral.', contingency: 'Ley Seca.' },
        '2026-04-11': { cat: 'red', reason: 'Feriado Juan Santamar√≠a (Finde Largo).', contingency: 'Promociones para los que se quedan en la ciudad.' },
        '2026-04-29': { cat: 'yellow', reason: 'Laura Pausini (Estadio Nacional).', contingency: 'Contra-programaci√≥n: Rock Cl√°sico / 80s.' },

        // --- MAYO 2026 ---
        '2026-05-01': { cat: 'red', reason: 'D√≠a del Trabajador.', contingency: 'Promoci√≥n: "El que trabaja se relaja" (Happy Hour extendido).' },
        '2026-05-30': { cat: 'red', reason: 'ED SHEERAN (Estadio Nacional). Masivo.', contingency: 'Evitar acceso vehicular. Promocionar a vecinos a pie.' },

        // --- JUNIO 2026 ---
        '2026-06-11': { cat: 'yellow', reason: 'Inicio MUNDIAL 2026.', contingency: 'Si hay TVs: Promo F√∫tbol. Si no: Ambiente Anti-F√∫tbol.' },
        '2026-06-21': { cat: 'green', reason: 'D√≠a del Padre (3er Domingo).', contingency: 'Men√∫ especial de carnes y destilados.' },

        // --- JULIO 2026 ---
        '2026-07-19': { cat: 'red', reason: 'Final Mundial 2026.', contingency: 'Pantallas gigantes o cerrar.' },
        '2026-07-25': { cat: 'red', reason: 'Anexi√≥n Nicoya (√âxodo).', contingency: 'Evento tem√°tico Guanacasteco.' },

        // --- AGOSTO 2026 ---
        '2026-08-01': { cat: 'red', reason: 'Romer√≠a.', contingency: 'Cerrar temprano.' },
        '2026-08-15': { cat: 'green', reason: 'D√≠a de la Madre.', contingency: 'Reservas obligatorias. Men√∫ especial.' },

        // --- SEPTIEMBRE 2026 ---
        '2026-09-15': { cat: 'blue', reason: 'Independencia.', contingency: 'Platos t√≠picos.' },

        // --- NOVIEMBRE 2026 ---
        '2026-11-18': { cat: 'yellow', reason: 'Eros Ramazzotti.', contingency: 'Noche de Rock.' },
        '2026-11-27': { cat: 'green', reason: 'Black Friday.', contingency: 'Ofertas agresivas en tragos.' },

        // --- DICIEMBRE 2026 ---
        '2026-12-25': { cat: 'red', reason: 'Navidad.', contingency: 'Cerrado.' }
    };

    const generatedEventData = {};

    const isPaydayNearby = (day) => {
        // Regla: Fin de semana de quincena es el m√°s cercano al 15 o 30
        return (day >= 13 && day <= 17) || (day >= 28) || (day <= 2);
    };

    const generateFullYearData = () => {
        // Loop from Dec 1 2025 to Dec 31 2026
        const startDate = new Date(2025, 11, 1);
        const endDate = new Date(2026, 11, 31);

        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const dayNum = String(d.getDate()).padStart(2, '0');
            const dateKey = `${y}-${m}-${dayNum}`;
            const dayOfWeek = d.getDay(); // 0 Sun, 5 Fri, 6 Sat

            // Priority 1: Fixed Events (Override everything)
            if (fixedEvents[dateKey]) {
                generatedEventData[dateKey] = { ...fixedEvents[dateKey], day: getDayName(dayOfWeek) };
                continue;
            }

            // Priority 2: Paydays (15th and 30th/End of Month)
            if (d.getDate() === 15 || d.getDate() === 30 || (d.getDate() === 28 && d.getMonth() === 1)) {
                 generatedEventData[dateKey] = { cat: 'blue', day: getDayName(dayOfWeek), reason: 'D√≠a de Pago.' };
                 continue;
            }

            // Priority 3: Logic for Weekends (Fri/Sat)
            if (dayOfWeek === 5 || dayOfWeek === 6) {
                
                // --- L√ìGICA CUESTA DE ENERO ---
                if (d.getMonth() === 0) { // Enero (Index 0)
                     if (isPaydayNearby(d.getDate())) {
                        generatedEventData[dateKey] = { 
                            cat: 'yellow', // Degraded from Green
                            day: getDayName(dayOfWeek), 
                            reason: 'Quincena en Cuesta de Enero (Gasto Escolar/Marchamo).',
                            contingency: 'Ofertas de valor (Combos familiares). No subir precios.'
                        };
                    } else {
                        generatedEventData[dateKey] = { 
                            cat: 'red', // Degraded from Yellow
                            day: getDayName(dayOfWeek), 
                            reason: 'Cuesta de Enero: Presupuesto de ocio agotado.',
                            contingency: 'Minimizar costos operativos. Eventos de bajo costo.'
                        };
                    }
                } 
                // --- RESTO DEL A√ëO ---
                else {
                    if (isPaydayNearby(d.getDate())) {
                        generatedEventData[dateKey] = { 
                            cat: 'green', 
                            day: getDayName(dayOfWeek), 
                            reason: 'Fin de Semana de Quincena.',
                            contingency: 'Maximizar ventas. Evento "Premium".'
                        };
                    } else {
                        generatedEventData[dateKey] = { 
                            cat: 'yellow', 
                            day: getDayName(dayOfWeek), 
                            reason: 'Fin de semana regular (No quincena).',
                            contingency: 'Promociones 2x1 o Happy Hour extendido para atraer flujo.'
                        };
                    }
                }
            }
        }
    };

    const getDayName = (d) => ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'][d];

    const climateData = [
        { month: 'Enero', risk: 'üü¢', estrategia: 'Clima perfecto, pero bolsillo vac√≠o. Terraza abierta.' },
        { month: 'Febrero', risk: 'üü¢', estrategia: 'Eventos al aire libre.' },
        { month: 'Marzo', risk: 'üü¢', estrategia: 'Bebidas fr√≠as/refrescantes.' },
        { month: 'Abril', risk: 'üü°', estrategia: 'Tener toldos listos por si acaso.' },
        { month: 'Mayo', risk: 'üü°', estrategia: 'Promoci√≥n "Si llueve, 2x1".' },
        { month: 'Junio', risk: 'üü°', estrategia: 'M√∫sica acogedora adentro.' },
        { month: 'Julio', risk: 'üü°', estrategia: 'Veranillo: Aprovechar ventanas de sol.' },
        { month: 'Agosto', risk: 'üü°', estrategia: 'Romer√≠a afecta tr√°fico.' },
        { month: 'Septiembre', risk: 'üî¥', estrategia: 'Eventos Indoor. Caf√© y postres.' },
        { month: 'Octubre', risk: 'üî¥', estrategia: 'Riesgo inundaciones. Delivery fuerte.' },
        { month: 'Noviembre', risk: 'üü°', estrategia: 'Transici√≥n. Fiestas de cierre de a√±o.' },
        { month: 'Diciembre', risk: 'üü¢', estrategia: 'Clima perfecto. Ventana Dorada.' },
    ];

    const analysisContent = [
        { title: 'La Cuesta de Enero', content: 'Enero es el mes m√°s dif√≠cil. Aunque el clima es perfecto (Verano), el presupuesto del cliente est√° comprometido por la entrada a clases, uniformes y marchamo. La estrategia debe cambiar de "Experiencia Premium" a "Solidaridad Econ√≥mica". No es momento de subir precios, sino de ofrecer combos.' },
        { title: 'Estrategia de Contra-Programaci√≥n', content: 'La clave para 2026 no es competir contra los gigantes, sino capturar al p√∫blico que no asiste a ellos. Ejemplo: Si Ed Sheeran toca balada pop, Antolog√≠as debe ofrecer una noche de Rock Cl√°sico o Trova para el p√∫blico que busca algo diferente.' },
        { title: 'El Ciclo de la Quincena', content: 'En Costa Rica, el comportamiento de consumo es binario: Hay dinero (Quincena) o no hay (Semana de Aclamaci√≥n). Hemos automatizado el calendario para marcar en VERDE los fines de semana cercanos al 15 y 30. Esos d√≠as no se hacen descuentos, se vende experiencia. Los fines de semana amarillos (lejanos al pago) son para promociones de volumen (2x1).' },
        { title: 'Factor Vial y Bad Bunny', content: 'El 5 y 6 de diciembre de 2025 ser√°n ca√≥ticos. La Sabana estar√° cerrada. La estrategia debe ser: "Ven antes del caos" (Almuerzos tard√≠os) o "After-Party" (para cuando termine el concierto y la gente quiera seguir la fiesta pero bajar la adrenalina).' }
    ];

    // --- VISUAL LOGIC ---

    const injectColorStyles = (palette) => {
        let style = document.getElementById('dynamic-color-styles');
        if (!style) {
            style = document.createElement('style');
            style.id = 'dynamic-color-styles';
            document.head.appendChild(style);
        }
        style.innerHTML = `
            .bg-green-opportunity { background-color: ${palette.opportunityHigh.bg}; color: ${palette.opportunityHigh.text}; }
            .bg-yellow-opportunity { background-color: ${palette.opportunityMedium.bg}; color: ${palette.opportunityMedium.text}; }
            .bg-red-opportunity { background-color: ${palette.opportunityLow.bg}; color: ${palette.opportunityLow.text}; }
            .bg-blue-payday { background-color: ${palette.payday.bg}; color: ${palette.payday.text}; }
        `;
        
        const root = document.documentElement;
        root.style.setProperty('--strategy-green-border', palette.opportunityHigh.bg);
        root.style.setProperty('--strategy-red-border', palette.opportunityLow.bg);
        root.style.setProperty('--strategy-yellow-border', palette.opportunityMedium.bg);
        
        if (isColorblindMode) {
            root.style.setProperty('--strategy-green-bg', `${palette.opportunityHigh.bg}20`);
            root.style.setProperty('--strategy-red-bg', `${palette.opportunityLow.bg}20`);
        } else {
            root.style.setProperty('--strategy-green-bg', `rgba(46, 125, 50, 0.2)`);
            root.style.setProperty('--strategy-red-bg', `rgba(198, 40, 40, 0.2)`);
        }
    };

    const getDayClass = (dateString) => {
        const data = generatedEventData[dateString];
        if (data) {
            if (data.cat === 'green') return 'bg-green-opportunity';
            if (data.cat === 'yellow') return 'bg-yellow-opportunity';
            if (data.cat === 'red') return 'bg-red-opportunity';
            if (data.cat === 'blue') return 'bg-blue-payday';
        }
        return 'bg-neutral-day';
    };

    const generateMonthGrid = (year, month) => {
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const dayNames = ["D", "L", "K", "M", "J", "V", "S"];
        
        let html = `<div class="p-4 dark-mode-surface rounded-xl shadow-md h-full border border-transparent hover:border-gray-600 transition-colors">
                <h3 class="font-bold text-center mb-3 text-lg dark-mode-text-header">${monthNames[month]} ${year}</h3>
                <div class="calendar-grid-header text-xs mb-2">`;
        
        dayNames.forEach(day => html += `<div class="font-semibold text-center dark-mode-text-accent opacity-80">${day}</div>`);
        html += `</div><div class="calendar-grid text-sm">`;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
            html += `<div class="bg-empty-day rounded-full"></div>`;
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dateObj = new Date(year, month, day);
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const d = String(dateObj.getDate()).padStart(2, '0');
            const dateString = `${y}-${m}-${d}`;
            
            const dayClass = getDayClass(dateString);
            let extraClasses = "day flex items-center justify-center font-semibold rounded-full cursor-pointer";
            if (dayClass === 'bg-neutral-day') extraClasses += " text-gray-400";
            
            const eventInfo = generatedEventData[dateString];
            const hasStar = (eventInfo && eventInfo.cat === 'green') ? '<span class="priority-star">‚òÖ</span>' : '';
            
            html += `<div class="${dayClass} ${extraClasses}" data-date="${dateString}">${day}${hasStar}</div>`;
        }
        html += `</div></div>`;
        return html;
    };

    const renderCalendars = (view) => {
        let html = `<div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">`;
        
        if (view === '2025-end') {
            html += generateMonthGrid(2025, 11);
        } else {
            for (let m = 0; m < 12; m++) {
                html += generateMonthGrid(2026, m);
            }
        }
        html += `</div>`;
        calendarsContainer.innerHTML = html;
    };

    const showDayDetails = (dateString) => {
        const data = generatedEventData[dateString];
        const [y, m, d] = dateString.split('-');
        const date = new Date(y, m - 1, d);
        
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = date.toLocaleDateString('es-CR', options);

        let html = `<h4 class="font-bold text-lg capitalize mb-2 border-b border-gray-600 pb-2">${formattedDate}</h4>`;
        
        if (data) {
            let emoji = data.cat === 'green' ? 'üü¢' : data.cat === 'yellow' ? 'üü°' : data.cat === 'red' ? 'üî¥' : 'üîµ';
            let text = data.cat === 'green' ? 'Oportunidad Alta' : data.cat === 'yellow' ? 'Riesgo Moderado' : data.cat === 'red' ? 'Riesgo Alto' : 'D√≠a de Pago';
            let color = currentActiveColorPalette.opportunityHigh.bg;
            if (data.cat === 'yellow') color = currentActiveColorPalette.opportunityMedium.bg;
            if (data.cat === 'red') color = currentActiveColorPalette.opportunityLow.bg;
            if (data.cat === 'blue') color = currentActiveColorPalette.payday.bg;

            html += `<p class="font-bold text-lg mb-3" style="color:${color}">${emoji} ${text}</p>`;
            html += `<p class="mb-2"><span class="font-semibold text-sm opacity-75 uppercase tracking-wider">An√°lisis:</span><br>${data.reason}</p>`;
            
            if (data.contingency) {
                 html += `<div class="mt-4 p-3 bg-gray-800 rounded border-l-4 border-amber-500 text-sm">
                    <span class="font-bold text-amber-500 block mb-1">‚ö° Recomendaci√≥n:</span>
                    ${data.contingency}
                 </div>`;
            }
            
        } else {
             html += `<p class="opacity-50 italic">D√≠a regular entre semana. Sin an√°lisis espec√≠fico.</p>`;
        }

        if (window.innerWidth < 1024) {
            detailsContentMobile.innerHTML = html;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
            }, 10);
        } else {
            detailsContentDesktop.innerHTML = html;
        }
    };

    // --- UI & EVENT LISTENERS ---

    const updateActiveYearBtn = (view) => {
        currentViewYear = view;
        const btn25 = document.getElementById('year-2025-btn');
        const btn26 = document.getElementById('year-2026-btn');
        
        const activeClass = isLightMode ? 'year-btn-active-light' : 'year-btn-active-dark';
        const inactiveClass = isLightMode ? 'year-btn-inactive-light' : 'year-btn-inactive-dark';

        [btn25, btn26].forEach(b => {
            b.classList.remove('year-btn-active-light', 'year-btn-active-dark', 'year-btn-inactive-light', 'year-btn-inactive-dark');
        });

        if (view === '2025-end') {
            btn25.classList.add(activeClass);
            btn26.classList.add(inactiveClass);
        } else {
            btn26.classList.add(activeClass);
            btn25.classList.add(inactiveClass);
        }
        renderCalendars(view);
    };

    const applyTheme = (light) => {
        if (light) {
            body.classList.add('light-mode');
            themeToggleBtn.textContent = 'üåô';
        } else {
            body.classList.remove('light-mode');
            themeToggleBtn.textContent = '‚òÄÔ∏è';
        }
        updateActiveYearBtn(currentViewYear);
        injectColorStyles(currentActiveColorPalette);
    };

    const filterCalendar = (cat) => {
        const days = document.querySelectorAll('.day');
        days.forEach(d => {
            d.classList.remove('day-filtered');
            if (cat === 'all') return;
            
            const dDate = d.dataset.date;
            const dData = generatedEventData[dDate];
            const dCat = dData ? dData.cat : 'neutral';

            if (cat !== dCat) d.classList.add('day-filtered');
        });
    };

    // Init Analysis Accordion
    const initAccordion = () => {
        const container = document.getElementById('accordion-container');
        let html = '';
        analysisContent.forEach(item => {
            html += `
                <div class="border dark-mode-border rounded-lg mb-2">
                    <button class="accordion-button w-full flex justify-between items-center text-left p-4 bg-[#383838] hover:bg-[#444444] rounded-lg transition-colors duration-300">
                        <span class="font-semibold text-lg dark-mode-text-header">${item.title}</span>
                        <svg class="w-6 h-6 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content dark-mode-surface rounded-b-lg px-4">
                        <p class="dark-mode-text-muted py-4 text-sm leading-relaxed">${item.content}</p>
                    </div>
                </div>`;
        });
        container.innerHTML = html;
        
        container.querySelectorAll('.accordion-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const content = btn.nextElementSibling;
                const icon = btn.querySelector('svg');
                const isOpen = content.style.maxHeight;
                
                container.querySelectorAll('.accordion-content').forEach(c => c.style.maxHeight = null);
                container.querySelectorAll('svg').forEach(s => s.style.transform = 'rotate(0deg)');

                if (!isOpen) {
                    content.style.maxHeight = content.scrollHeight + "px";
                    icon.style.transform = 'rotate(180deg)';
                }
            });
        });
    };

    // Init Climate Table
    const initClimate = () => {
        const tbody = document.querySelector('#climate-table tbody');
        let html = '';
        climateData.forEach(c => {
            let colorClass = c.risk.includes('üü¢') ? 'text-green-400' : c.risk.includes('üü°') ? 'text-yellow-400' : 'text-red-400';
            html += `<tr class="border-b dark-mode-border hover:bg-white/5 transition-colors">
                <th class="px-6 py-4 font-medium text-gray-100">${c.month}</th>
                <td class="px-6 py-4 ${colorClass} font-bold text-lg">${c.risk}</td>
                <td class="px-6 py-4 text-sm">${c.estrategia}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
    };

    // Listeners
    document.getElementById('year-2025-btn').addEventListener('click', () => updateActiveYearBtn('2025-end'));
    document.getElementById('year-2026-btn').addEventListener('click', () => updateActiveYearBtn('2026'));
    document.getElementById('print-btn').addEventListener('click', () => window.print());
    
    themeToggleBtn.addEventListener('click', () => {
        isLightMode = !isLightMode;
        localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
        applyTheme(isLightMode);
    });

    document.getElementById('colorblind-toggle').addEventListener('click', () => {
        isColorblindMode = !isColorblindMode;
        localStorage.setItem('colorblind', isColorblindMode);
        currentActiveColorPalette = isColorblindMode ? colorblindColorPalette : defaultColorPalette;
        injectColorStyles(currentActiveColorPalette);
        renderCalendars(currentViewYear);
    });

    calendarsContainer.addEventListener('click', (e) => {
        const d = e.target.closest('.day');
        if (d) {
            if (selectedDayElement) selectedDayElement.classList.remove('selected');
            d.classList.add('selected');
            selectedDayElement = d;
            showDayDetails(d.dataset.date);
        }
    });

    Object.keys(navButtons).forEach(key => {
        navButtons[key].addEventListener('click', () => {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            Object.values(navButtons).forEach(b => {
                b.classList.remove('nav-active');
                b.classList.add('nav-inactive');
            });
            views[key].classList.remove('hidden');
            navButtons[key].classList.add('nav-active');
            navButtons[key].classList.remove('nav-inactive');
        });
    });

    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            filterButtons.forEach(b => b.classList.remove('filter-btn-active'));
            btn.classList.add('filter-btn-active');
            filterCalendar(btn.dataset.filter);
        });
    });

    modalCloseBtn.addEventListener('click', () => {
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    });

    // Init
    generateFullYearData(); // THIS GENERATES THE DYNAMIC DATA
    injectColorStyles(currentActiveColorPalette);
    applyTheme(isLightMode);
    renderCalendars(currentViewYear);
    initAccordion();
    initClimate();
});
</script>
</body>
</html>
